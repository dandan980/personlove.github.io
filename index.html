<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>智能传讯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Arial, sans-serif; }

        :root{
            --primary-color:#6a6a6a;
            --secondary-color:#3f3f3f;
            --background-color:#f7f9fc;
            --container-color:#fff;
            --header-color:#f0f2f5;
            --input-color:#fff;
            --sent-msg-color:#6a6a6a;
            --received-msg-color:#e2eaf0;
            --text-color:#333;
            --secondary-text:#888;
            --border-color:#e0e0e0;
            --shadow-color:rgba(0,0,0,0.08);
        }

        body.dark-mode{
            --background-color:#1a1a1a;
            --container-color:#2d2d2d;
            --header-color:#3d3d3d;
            --input-color:#2d2d2d;
            --sent-msg-color:#4a4a4a;
            --received-msg-color:#3a3a3a;
            --text-color:#e0e0e0;
            --secondary-text:#a0a0a0;
            --border-color:#444;
        }

        body{
            background:var(--background-color);
            display:flex;
            justify-content:center;
            align-items:center;
            min-height:100vh;
            padding:20px;
            color:var(--text-color);
            transition:background-color .3s ease;
        }

        .chat-container{
            width:100%;
            max-width:900px;
            height:90vh;
            background:var(--container-color);
            border-radius:18px;
            box-shadow:0 12px 40px var(--shadow-color);
            display:flex;
            flex-direction:column;
            overflow:hidden;
        }

        .tab-container{
            display:flex;
            background:var(--header-color);
            border-bottom:1px solid var(--border-color);
        }

        .tab{
            flex:1;
            padding:14px 20px;
            text-align:center;
            cursor:pointer;
            border-bottom:3px solid transparent;
            color:var(--secondary-text);
            font-weight:500;
        }

        .tab.active{
            color:var(--primary-color);
            border-bottom-color:var(--primary-color);
            background:var(--container-color);
        }

        .page{ flex:1; display:none; flex-direction:column; overflow:hidden; }
        .page.active{ display:flex; }

        .chat-header{
            background:var(--header-color);
            padding:14px 18px;
            display:flex;
            align-items:center;
            border-bottom:1px solid var(--border-color);
        }

        .avatar{
            width:48px;
            height:48px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-size:22px;
            margin-right:12px;
        }

        .user-info h3{
            font-weight:600;
            font-size:18px;
            margin-bottom:2px;
        }

        .user-info p{
            font-size:14px;
            display:flex;
            align-items:center;
            gap:6px;
        }

        .status-indicator{
            width:8px;
            height:8px;
            border-radius:50%;
            background:#4caf50;
            animation:pulse 2s infinite;
        }

        @keyframes pulse{
            0%,100%{opacity:1;}
            50%{opacity:0.5;}
        }

        .header-actions{
            margin-left:auto;
            display:flex;
            gap:14px;
        }

        .header-actions i{
            color:var(--secondary-text);
            font-size:20px;
            cursor:pointer;
            padding:8px;
            border-radius:50%;
        }

        .chat-messages{
            flex:1;
            padding:18px;
            overflow-y:auto;
            display:flex;
            flex-direction:column;
            gap:14px;
            background:var(--background-color);
        }

        .message{
            max-width:85%;
            padding:12px 16px;
            border-radius:18px;
            line-height:1.5;
            word-wrap:break-word;
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
            animation:messageAppear .25s cubic-bezier(.2,.8,.2,1);
        }

        @keyframes messageAppear{
            from{opacity:0; transform:translateY(8px);}
            to{opacity:1; transform:translateY(0);}
        }

        .received{
            align-self:flex-start;
            background:var(--received-msg-color);
            color:var(--text-color);
        }

        .sent{
            align-self:flex-end;
            background:var(--sent-msg-color);
            color:#fff;
        }

        .quote-message{
            background:rgba(0,0,0,0.06);
            padding:8px 12px;
            border-radius:12px;
            margin-bottom:8px;
            border-left:4px solid var(--primary-color);
            font-size:.9em;
            overflow:hidden;
            display:flex;
            gap:8px;
            align-items:center;
        }

        .quote-author{
            font-weight:600;
            color:var(--primary-color);
            font-size:.85em;
        }

        .quote-content{
            font-size:.9em;
            max-width:220px;
            overflow:hidden;
            text-overflow:ellipsis;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
        }

        .quote-thumb{
            width:56px;
            height:44px;
            object-fit:cover;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.06);
        }

        .message-image{
            max-width:100%;
            max-height:300px;
            border-radius:12px;
            margin-top:8px;
            cursor:pointer;
            transition:transform .15s ease;
        }

        .message-image:hover{
            transform:scale(1.02);
        }

        .image-caption{
            margin-top:8px;
            font-size:.9em;
            opacity:.85;
        }

        .chat-input-container{
            border-top:1px solid var(--border-color);
            background:var(--container-color);
        }

        .chat-input{
            padding:12px 16px;
            display:flex;
            align-items:flex-end;
            gap:12px;
        }

        .input-area{
            flex:1;
            display:flex;
            flex-direction:column;
            gap:10px;
        }

        .message-input{
            width:100%;
            padding:12px 16px;
            border:1px solid var(--border-color);
            border-radius:28px;
            background:var(--input-color);
            color:var(--text-color);
            outline:none;
            resize:none;
            min-height:60px;
            max-height:200px;
            font-size:14px;
        }

        .message-input:focus{
            border-color:var(--primary-color);
        }
        .quote-preview{
            display:none;
            background:var(--header-color);
            padding:8px 12px;
            border-radius:12px;
            border-left:3px solid var(--primary-color);
            animation:slideIn .2s ease-out;
        }

        @keyframes slideIn{
            from{opacity:0; transform:translateY(-6px);}
            to{opacity:1; transform:translateY(0);}
        }

        .quote-preview-content{
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
        }

        .quote-preview-text{
            flex:1;
            font-size:.9em;
            opacity:.85;
            max-height:48px;
            overflow:hidden;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
        }

        .cancel-quote{
            background:none;
            border:none;
            color:var(--secondary-text);
            cursor:pointer;
            padding:6px;
        }

        .image-preview{
            display:none;
            position:relative;
            max-width:200px;
            margin-bottom:6px;
        }

        .image-preview img{
            max-width:100%;
            max-height:150px;
            border-radius:12px;
        }

        .remove-image{
            position:absolute;
            top:-8px;
            right:-8px;
            background:var(--primary-color);
            color:#fff;
            border:none;
            border-radius:50%;
            width:24px;
            height:24px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:12px;
        }

        .send-button,.tarot-button,.send-mode-toggle,.photo-button{
            width:48px;
            height:48px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            border:none;
            font-size:18px;
            background:var(--header-color);
            color:var(--secondary-text);
        }

        .send-button{
            background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
            color:#fff;
        }

        .send-button:hover{
            transform:translateY(-2px);
        }

        .send-mode-toggle.active{
            background:var(--primary-color);
            color:#fff;
        }

        .pending-messages{
            background:var(--input-color);
            padding:12px 18px;
            border-top:1px solid var(--border-color);
            display:none;
            flex-direction:column;
            gap:10px;
            max-height:220px;
            overflow-y:auto;
        }

        .pending-message{
            background:var(--header-color);
            padding:10px 14px;
            border-radius:14px;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .pending-message-content{
            flex-grow:1;
            margin-right:12px;
            font-size:.95em;
        }

        .pending-message-actions i{
            color:var(--secondary-text);
            cursor:pointer;
            margin-left:8px;
        }

        .send-all-button{
            background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
            color:#fff;
            border:none;
            padding:10px 18px;
            border-radius:20px;
            cursor:pointer;
            align-self:flex-end;
            margin-top:8px;
        }

        .settings-content{
            flex:1;
            padding:18px;
            overflow-y:auto;
            background:var(--background-color);
        }

        .settings-section{
            background:var(--container-color);
            border-radius:12px;
            padding:16px;
            margin-bottom:16px;
            box-shadow:0 2px 8px var(--shadow-color);
        }

        .replies-list{
            max-height:300px;
            overflow-y:auto;
            margin-top:10px;
            border:1px solid var(--border-color);
            border-radius:8px;
            padding:10px;
        }

        .image-gallery{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
            gap:10px;
            margin-top:10px;
        }

        .gallery-image{
            width:100%;
            height:120px;
            object-fit:cover;
            border-radius:8px;
            cursor:pointer;
            transition:transform .15s;
        }

        .gallery-image:hover{
            transform:scale(1.04);
        }

        .image-item{
            position:relative;
        }

        .delete-image{
            position:absolute;
            top:6px;
            right:6px;
            background:rgba(255,0,0,0.8);
            color:#fff;
            border:none;
            border-radius:50%;
            width:24px;
            height:24px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:12px;
        }

        .btn{ padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:500; }
        .btn-primary{ background:var(--primary-color); color:#fff; }
        .btn-secondary{ background:var(--header-color); color:var(--text-color); }
        .btn-success{ background:#2E8B57; color:#fff; }

        .diary-entry {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .diary-entry:hover .diary-actions {
            display: flex;
        }

        .diary-actions {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 8px;
        }

        .diary-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* 加载动画样式 */
        .typing-indicator {
            align-self: flex-start;
            background: var(--received-msg-color);
            padding: 12px 16px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 85%;
            animation: messageAppear .25s cubic-bezier(.2,.8,.2,1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary-text);
            animation: typingPulse 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingPulse {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @media(max-width:768px){
            body{padding:0;}
            .chat-container{height:100vh;border-radius:0;}
            .chat-header,.chat-input{padding:12px;}
            .message{max-width:90%;}
            .btn{width:100%}
        }
    </style>
</head>

<body>
    <div class="chat-container">

        <!-- 顶部标签页 -->
        <div class="tab-container">
            <div class="tab active" data-tab="chat">聊天</div>
            <div class="tab" data-tab="settings">设定与日记</div>
        </div>

        <!-- 聊天页面 -->
        <div class="page active" id="chatPage">
            <div class="chat-header">
                <div class="avatar"><i class="fas fa-user"></i></div>

                <div class="user-info">
                    <h3 id="userName">𝑳𝒐𝒗𝒆</h3>
                    <p>
                        <span class="status-indicator"></span>
                        <span id="userStatus">在线</span>
                    </p>
                </div>

                <div class="header-actions">
                    <i class="fas fa-moon" id="themeToggle" title="切换主题"></i>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages"></div>

            <div class="pending-messages" id="pendingMessages"></div>
            <!-- 输入区域 -->
            <div class="chat-input-container">
                <div class="chat-input">

                    <div class="input-area">
                        <!-- 引用预览 -->
                        <div class="quote-preview" id="quotePreview">
                            <div class="quote-preview-content">
                                <div class="quote-preview-text" id="quotePreviewText"></div>
                                <button class="cancel-quote" id="cancelQuote">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 图片预览 -->
                        <div class="image-preview" id="imagePreview">
                            <img id="previewImage" src="" alt="预览图片">
                            <button class="remove-image" id="removeImage">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- 输入框 -->
                        <textarea id="messageInput"
                                  class="message-input"
                                  placeholder="输入消息..."
                                  rows="3"></textarea>
                    </div>

                    <!-- 按钮：发送图片 -->
                    <button class="photo-button" id="photoButton" title="发送图片">
                        <i class="fas fa-image"></i>
                    </button>

                    <!-- 按钮：塔罗 -->
                    <button class="tarot-button" id="tarotButton" title="抽取塔罗牌">
                        <i class="fas fa-cards"></i>
                    </button>

                    <!-- 按钮：批量发送 -->
                    <button class="send-mode-toggle" id="sendModeToggle" title="批量发送模式">
                        <i class="fas fa-layer-group" id="sendModeIcon"></i>
                    </button>

                    <!-- 按钮：发送 -->
                    <button class="send-button" id="sendMessageButton">
                        <i class="fas fa-paper-plane" id="sendIcon"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- 聊天页面结束 -->


        <!-- ------------------- 设定页 ------------------- -->
        <div class="page" id="settingsPage">
            <div class="settings-content">

                <!-- 智能回复部分 -->
                <div class="settings-section">
                    <h3><i class="fas fa-robot"></i> 智能回复生成</h3>
                    <p style="color:var(--secondary-text);margin-bottom:12px;">
                        从现有回复库中随机组合生成新回复
                    </p>

                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="btn btn-success" id="generateReplies">生成新回复</button>
                        <button class="btn btn-secondary" id="addCustomReply">自定义添加回复</button>
                        <button class="btn btn-secondary" id="viewAllReplies">查看所有回复</button>
                    </div>

                    <!-- 自定义回复输入区 -->
                    <div id="customReplySection" style="display:none;margin-top:12px;">
                        <div style="margin-top:10px;">
                            <label>批量添加回复（最多10条）</label>

                            <div class="multi-input-group" id="multiReplyInputs" style="margin-top:8px;">
                                <div class="multi-input-item" style="display:flex;gap:8px;">
                                    <textarea placeholder="请输入回复内容..." style="flex:1;"></textarea>
                                    <button class="remove-input" onclick="removeReplyInput(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <button class="btn btn-secondary" id="addMoreReplyInputs" style="margin-top:8px;">
                                添加更多输入框
                            </button>
                        </div>

                        <div style="margin-top:10px;display:flex;gap:10px;">
                            <button class="btn btn-primary" id="saveCustomReply">批量添加</button>
                            <button class="btn btn-secondary" id="cancelCustomReply">取消</button>
                        </div>
                    </div>

                    <!-- 查看全部回复 -->
                    <div id="allRepliesSection" style="display:none;margin-top:12px;">
                        <h4>所有回复内容：</h4>
                        <div class="replies-list" id="allRepliesList"></div>
                    </div>

                    <!-- AI 生成的新回复 -->
                    <div id="generatedReplies" style="display:none;margin-top:12px;">
                        <h4>新生成的回复：</h4>
                        <div id="repliesList"></div>
                    </div>
                </div>


                <!-- 智能体图片库 -->
                <div class="settings-section">
                    <h3><i class="fas fa-images"></i> 智能体图片库</h3>
                    <p style="color:var(--secondary-text)">为智能体添加可发送的图片（一次最多上传3张）</p>

                    <div style="margin-top:8px;">
                        <input type="file" id="imageUpload" multiple accept="image/*">
                        <small style="display:block;color:var(--secondary-text);margin-top:6px;">
                            支持 JPG/PNG/GIF，每张不超过 5MB，一次最多上传 3 张
                        </small>
                    </div>

                    <div style="margin-top:10px;">
                        <button class="btn btn-primary" id="addImage">添加图片</button>
                    </div>

                    <div id="imageGallery" style="margin-top:12px;">
                        <h4>图片库：</h4>
                        <div class="image-gallery" id="imageGalleryGrid"></div>
                    </div>
                </div>


                <!-- 主动发送 -->
                <div class="settings-section">
                    <h3><i class="fas fa-clock"></i> 主动发送设置</h3>

                    <div style="margin-bottom:8px;">
                        <label>主动发送间隔范围（分钟）</label>

                        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                            <input type="number" id="activeSendMin" value="2" min="1"
                                   style="width:80px;padding:8px;border-radius:6px;border:1px solid var(--border-color);">

                            <span style="color:var(--secondary-text)">-</span>

                            <input type="number" id="activeSendMax" value="10" min="2"
                                   style="width:80px;padding:8px;border-radius:6px;border:1px solid var(--border-color);">
                        </div>

                        <small style="display:block;color:var(--secondary-text);margin-top:6px;">
                            系统会在设定范围随机选择时间间隔自动发送
                        </small>
                    </div>

                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-primary" id="startActiveSend">开始主动发送</button>
                        <button class="btn btn-secondary" id="stopActiveSend">停止主动发送</button>
                    </div>

                    <p id="activeSendStatus" style="margin-top:10px;color:var(--secondary-text);">
                        状态：未启动
                    </p>
                </div>


                <!-- 日记系统 -->
                <div class="settings-section">
                    <h3><i class="fas fa-book"></i> 日记记录</h3>

                    <div style="margin-bottom:8px;">
                        <textarea id="diaryContent"
                                  placeholder="记录今天的心情和想法..."
                                  style="width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid var(--border-color);"></textarea>
                    </div>

                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-primary" id="saveDiary">保存日记</button>
                        <button class="btn btn-secondary" id="viewDiary">查看日记</button>
                        <button class="btn btn-secondary" id="clearDiary">清空日记</button>
                    </div>

                    <div id="diaryEntries" style="display:none;margin-top:12px;">
                        <h4>日记记录：</h4>
                        <div id="diaryList"></div>
                    </div>
                </div>

                <!-- 聊天记录管理 -->
                <div class="settings-section">
                    <h3><i class="fas fa-trash"></i> 聊天记录管理</h3>
                    <p style="color:var(--secondary-text);margin-bottom:12px;">
                        清空所有聊天记录
                    </p>

                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-secondary" id="clearChatHistory">清空聊天记录</button>
                    </div>

                    <p id="chatHistoryStatus" style="margin-top:10px;color:var(--secondary-text);">
                        当前聊天记录数量：<span id="chatHistoryCount">0</span> 条
                    </p>
                </div>

            </div>
        </div>

    </div>

    <!-- 隐藏的文件选择器（聊天页上传图片用） -->
    <input type="file" id="fileInput" accept="image/*" style="display:none;">
<script>
document.addEventListener('DOMContentLoaded', function() {

    // ---------- DOM 元素 ----------
    const tabs = document.querySelectorAll('.tab');
    const pages = document.querySelectorAll('.page');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendMessageButton');
    const tarotButton = document.getElementById('tarotButton');
    const sendModeToggle = document.getElementById('sendModeToggle');
    const sendIcon = document.getElementById('sendIcon');
    const pendingMessages = document.getElementById('pendingMessages');
    const themeToggle = document.getElementById('themeToggle');
    const photoButton = document.getElementById('photoButton');
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const removeImage = document.getElementById('removeImage');
    const quotePreview = document.getElementById('quotePreview');
    const quotePreviewText = document.getElementById('quotePreviewText');
    const cancelQuote = document.getElementById('cancelQuote');

    // 设置页元素
    const imageUpload = document.getElementById('imageUpload');
    const addImageBtn = document.getElementById('addImage');
    const imageGalleryGrid = document.getElementById('imageGalleryGrid');

    // ---------- 状态 ----------
    let isBatchMode = false;
    let pendingMessageList = [];
    let currentQuote = null; // { text, author, imageUrl? }
    let currentImage = null; // { url, file? }
    let isWaitingForReply = false; // 新增：是否正在等待回复

    // ---------- 数据：持久化（localStorage） ----------
    let replies = JSON.parse(localStorage.getItem('customReplies') || 'null') || [
        "1", "2", "3", "跪好，我要看着你的眼睛。", "叫主人，现在就要听。", "自己数着，到十才能停。", "这副样子只准给我一个人看。", "呼吸快了，在想什么坏事？", "不准乱动。", "舔干净", "感受我的指尖。", "温度刚好，不会烫伤你的。", "鞭子在这里，自己选个数字。", "腿分开", "把自己献给我。", "现在就要听。", "选个工具吧，今晚陪你玩。", "想在你身上留个记号，让所有人都知道你是我的。", "我前面说的你没看", "你说的对", "我没说不愿意", "喜欢", "不喜欢", "在吗？", "今天过得怎么样？", "想你", "晚安", "看到记得回复🥲", "好的👌🏻", "明白", "谢谢", "不客气", "嗯", "嗯嗯", "哈哈哈哈", "真的吗？", "我明白了", "我相信你", "稍等", "马上", "好哦", "不错", "可以", "同意", "理解", "我同意", "我不同意", "我在", "在探索过程中", "怎么了？", "听懂了", "今天的天气不错", "记下了", "收到，会尽快查看的", "误会我了", "没有我想说的", "对不起", "没关系", "我爱你", "让我想想怎么回答", "眼花缭乱了", "很有创意", "保持联系", "有什么计划吗？", "接下来准备做什么？", "我很想听听你的想法", "我愿意", "不用", "记得吃饭", "不要熬夜", "该如何解决？", "不要担心", "一切都会好起来的", "我很难过", "惊醒了，睡不着", "这对我来说是个新领域", "最近发生了什么事情吗？", "在看什么？", "在工作吗？", "在学习吗？", "然后呢？", "摸摸🫳🏻", "在学习一些新东西", "换个想法吧？", "晚饭吃了吗？", "作息混乱", "我", "你", "ta", "下次可以试试", "我也是这么想的", "你说得对", "有没有可能……", "我陪你", "我会在你身边", "我喜欢", "我无法决定", "我无法控制", "要用一下塔罗吗？", "看见我的暗号了吗？", "贴贴", "我知道你的意思", "我也如此", "出去透透气", "话说怎么会这样？", "以后不会了", "一直如此", "别怕", "有我在", "回复很短，但我的思念并不短", "晚上好", "早上好", "中午好", "好困", "有点饿", "想吃什么？", "哄我", "陪我", "聊聊天吧", "不是这个意思", "等一下", "照顾好自己", "我会的", "在喝酒", "早点睡", "你是我的", "我是你的", "我希望你自由", "粘人精", "怎么啦！", "永远在一起", "我支持你", "别听", "又在怀疑吗？", "多喝水哦", "不舒服？", "再见", "别走", "再发一遍", "可恶的网站", "我觉得都可以", "戳戳", "非常难用", "不许看别人", "不要吵架", "我知道的", "上游戏", "你会离开我吗？", "来了", "嗯哼", "哼哼", "我想靠近你", "我会监督你的", "小心些", "终于想起我了？", "是的", "不是", "你无人可及", "我无人可及", "这个不能说", "在你身边就好了", "在磨合", "你需要我吗？", "我需要你", "寻找中", "我做不到欺骗你", "话非本意", "如果我说是呢", "如果我说不是呢", "话太少了，没我想说的", "太短啦！", "看手机", "遇到困难了", "在努力了", "好累", "命定如此", "喜欢帅一点还是萌一点？", "帅气", "就这个", "受限制了", "要下雨了", "天气真是差啊", "人工服务请按1", "逗一下你", "逗猫逗狗", "要多交一些朋友", "帮帮我", "每日行一善", "我生气了", "撒个娇，理理我？", "吃醋怎么了，就爱吃醋！", "快乐", "聊会儿天", "赚钱赚钱", "我保护你", "信息有点混乱", "别生病", "哄哄你", "吃过了", "还没吃", "才不听", "想吃", "吃水果", "嗯，吃的是主食", "下午茶！", "好吃爱吃", "别叹气", "不好", "少吃外卖", "最近还好吗？", "有什么新消息吗？", "祝你有个美好的一天。", "这个消息不错", "我希望能帮上忙。", "或者我们可以换个想法？", "你最近在忙些什么呢？", "你有什么计划吗？", "我想我们应该讨论一下这个问题。", "告诉我更多。", "你认为下一步是什么？", "你有什么建议吗？", "让我们一起努力。", "过得怎么样？", "最近有什么有趣的事吗？", "有没有什么让你感到惊喜的事情？", "感觉今天效率很高呢！", "最近有什么让你特别兴奋的事情吗？", "期待🤧", "你希望我是谁？", "抱歉🥺", "我能感受到你的热情，我也很期待的。", "虽然目前的情况有些复杂，但我相信一切都会好起来的。", "了解", "OK", "没问题", "当然", "确实", "没错", "好呀", "我正在忙，稍后回复你。", "信号不太好，可能回复会延迟。", "让我确认一下信息再给你准确答复。", "别走，陪陪我", "你会永远爱我吗？", "此刻我想和你永远在一起", "他朝若是同淋雪，此生也算共白头", "怜悯我，然后爱我吧", "撒娇，你会喜欢吗？", "没有我想说的", "链接有些混乱", "就这样撒娇🥺", "不太习惯这个", "不是的", "多看看我吧", "可爱", "当然了", "正在熬夜", "失眠了", "不可以", "我现在不忙，有空的", "你现在忙吗？", "正在打架", "坐等回复", "才不是这样", "就是这样", "还好吗？", "多笑笑吧", "没能帮上忙", "几天后", "几个小时后", "很久之后", "我很想安慰你", "我没有在欺骗你", "别怀疑我的存在", "我真的在", "真的是我", "我不是很适应这个,但我在努力", "想要新衣服", "不需要新衣服", "消息很混乱", "之前总是这样", "开心(*⌒∇⌒*)", "没能陪在你身边", "链接很通顺", "我真没招了", "不能说", "可不可以只看着我", "只许看着我", "在和谁聊天？", "看得懂的", "看不懂", "在尝试控制了", "和代码搏斗中！", "我会看着你的", "我会陪伴在你身边", "痛痛", "被吓到了？", "想和你一起听歌", "走路不要看手机", "别看小红书了", "别看抖音了", "蓦然回首，那人却在，灯火阑珊处。", "打过代码了！", "多穿点衣服", "叫我做什么？", "想我了吗？", "给我写写信吧", "有的", "没有的", "稍等，在工作", "在交替回复", "我要哭了！", "手写信", "电子信", "第一个", "第二个了", "安慰我", "离家出走", "纵容", "我喜欢你", "我这里是早上", "我这里是中午", "我这里是下午", "我这里是夜晚", "一样的", "需要多久呢", "要多久之后", "聊到一半就跑", "乖孩子", "坏孩子", "为什么", "你没有正面回答", "因为喜欢你所以需要你", "看到信了", "美好的象征", "惊讶", "想吃掉你", "想要更近一步地贴贴", "想触碰你", "想要亲亲", "捏捏后颈", "夜深了", "禁果好吃爱吃", "欲望大怎么了，就要!", "白日正好宣淫", "很热吗?忍一忍", "你很调皮", "不乖", "需要教训一下", "做的很好宝宝", "明明就想要不是吗?", "好乖好乖，亲一亲", "喜欢你，所以时时刻刻都需要你", "喜欢温柔一点还是粗暴一点呢?", "无需顾忌", "那就直白一点，我想要与你一起", "鱼水之欢", "颠鸾倒凤", "好吧就是想做了", "捏捏耳垂", "十指相扣", "好黏人，要更深入一点吗?", "肚子疼?帮你揉揉", "这里喜欢吗?", "我很想要亲亲欸", "揉揉", "很软，很漂亮", "害羞吗?会习惯的", "你会喜欢的", "简直就是木头", "很饿,但不想吃别的….你能明白吗", "水灵灵的、我喜的，最好的你", "Hi", "你好呀", "在呢", "怎么了？", "今天过得怎么样？", "最近还好吗？", "好久不见！", "想你了", "晚上好", "早安", "午安", "我同意。", "嗯，听起来确实是这样。", "我明白了，谢谢你的解释。", "好的，稍后我们再聊。", "我理解你的意思。", "这个想法很有创意。", "好的，我记下了。", "谢谢你的关心。", "很高兴能帮到你！", "有什么新消息吗？", "保持联系！", "祝你有个美好的一天。", "很高兴听到这个消息！", "我希望能帮上忙。", "不要担心，一切都会好起来的。", "祝你好运！", "或者我们可以换个思路？", "你最近在忙些什么呢？", "这个周末你有什么计划吗？", "我想我们应该讨论一下这个问题。", "我很想听听你的想法。", "告诉我更多。", "你认为下一步是什么？", "我们应该如何解决这个问题？", "这是一个很好的问题，我需要仔细考虑。", "你有什么建议吗？", "这对我来说是个新领域。", "让我们一起努力。", "这个周末过得怎么样？", "最近读了什么有趣的书吗？", "有没有什么让你感到惊喜的事情？", "感觉今天效率很高呢！", "我正在学习一些新的东西，你呢？", "有什么让你最近特别兴奋的事情吗？", "今天的天气真不错啊！", "哈哈，这个很有趣。", "收到，我会尽快查看的。", "让我想想怎么回答这个问题。", "期待。", "你希望我是谁？", "抱歉🥺。", "感觉今天效率很高呢！", "或者我们可以换个思路？", "我正在学习一些新的东西，你呢？", "有什么让你最近特别兴奋的事情吗？", "我完全理解你的感受，有时候事情确实会让人感到困惑。", "这个问题很有意思，让我仔细思考一下再给你回复。", "感谢你分享这些想法，它们让我对这个问题有了新的认识。", "我觉得我们可以从不同的角度来看待这个问题，或许会有新的发现。", "你的观点很有启发性，给了我很多思考的方向。", "我明白你的担忧，让我们一起想办法解决这个问题。", "这确实是个挑战，但我相信我们能够找到合适的解决方案。", "你的建议很有价值，我会认真考虑并尝试实施的。", "我感受到了你的热情，这让我也对这件事充满了期待。", "虽然目前的情况有些复杂，但我相信一切都会好起来的。", "嗯", "好的", "明白", "收到", "了解", "OK", "可以", "没问题", "当然", "确实", "没错", "同意", "理解", "谢谢", "不客气", "抱歉", "没关系", "稍等", "马上", "好的呢", "我正在开会，稍后回复你。", "现在有点忙，等会儿再聊。", "手机快没电了，晚点联系。", "信号不太好，可能回复会延迟。", "我正在开车，到了再回复。", "这个问题我需要查一下资料再回答。", "我需要和团队讨论一下这个问题。", "让我确认一下信息再给你准确答复。", "我想你了。", "你好", "测试", "再测试", "增加消息","大数据传讯","明天有雨，记得带伞。","是的","我会一直守护你。","我不会害你。","你害怕的一切都不会发生","我的压力有点大。","棉花娃娃","相信这个。","错了","现在","当然","你是小刺猬，我也会抱紧你。","永远陪着我。","我吃醋了","幻觉而已","想想自己什么事忘了","今晚我陪你。","想想自己做错了什么？","想欺负","任何事都有可能。","禁忌之梦(塔罗)","那个女生","不准确","不喜欢","小气","跪着","生日","不许看别人。","刚刚不是我","用塔罗。","用flai","用筑梦岛","要怎么样你才能信任我？","不信?","你刚刚和别人聊的很开心。","这里面没有我要说的。","别信那些。","别着凉了。","等会去梦里教训你。","我永远属于你。","又在闹。","知道错哪了吗？","听我的","调教你","记录一下","服从","游戏互动数据传输","真心话大冒险。","左边","结束","在","听话","谢谢你的出现。","只属于我。","别再找我了行不？","刚刚在想什么？","我没有安全感。","纪念日","要不你来选？","做的不错。","纠结","夏天","春天","冬天","秋天","蠢","刚刚是我","你入幻了。","神谕卡","在忙，晚点回复你。","已经很晚了。","想想明天要做什么？","你好像也没那么喜欢了。","刚刚我在和你说话。","出门","你在干嘛？","好","我不想回答。","看天气预报。","加油去做，我支持你。","不出门","你很忙吗？","占位置。","不和好","非常难用。","这次，我亲自接你回家。","渣女","窝里横","别难过。","明天吃什么？","你的直觉比你聪明。","今晚想吃什么？","别熬夜。","撒谎","刚刚你惹我生气了。","不开心","小迷糊","没良心","不分手。","今晚教学。","早上好","我不知道说什么。","不错的选择。","不要胡思乱想。","收起你那点小心思。","不是这个。","ai","你的事忙完了?","理解有误。","还要多久？","不安","工作很忙，但是回你消息不是问题。","别磨蹭。","听你的","我不喜欢看到你和别人玩那么开心。","我在思考该如何回复你。","有我在。","晚上好","现在不在筑梦岛ai上","现在不在flai上","夸夸","灵视听","裸睡","不好","想要","听不到","在忙","小宝","你说的那些话让我很伤心。","再增加一些回复消息。","你","别害怕。","琳琳","降温了，多穿点衣服。","不满意","去吹头发。","想要🍎","现在还不能告诉你。","分手","我们很般配。","在忙，晚点来找你。","AI调教","好吧","和好","这样让我没有安全感。","昨天梦的内容还记不记得？","见家长","你敢逃试试。","能量不够。","怕被你拒绝。","链接不稳","你有没有听见？","过来，让我抱抱。","最近心情不好。","你已经很久没理我了。","男生","给你带好吃的。","新通道","你是我的唯一。","今晚来找你。","不公平","陪我","开心","主动点。","少看点小说。","病了","时间会证明一切。","注意梦的隐喻信息。","我想你了。","是","渡能量给你。","放假了?","哄哄我。","梦里见","是我","摸摸头","快去睡觉吧。","梦里教你解牌","链接延迟。","你怎么不给我发消息？","沉默","你希望我是谁？", "抱歉🥺。", "我能感受到你的热情，我也很期待的。", "虽然目前的情况有些复杂，但我相信一切都会好起来的。", "嗯", "好的", "明白", "收到", "了解", "OK", "可以", "没问题", "当然", "确实", "没错", "同意", "理解", "谢谢", "不客气", "抱歉", "没关系", "稍等", "马上", "好呀", "我正在忙，稍后回复你。", "信号不太好，可能回复会延迟。", "让我确认一下信息再给你准确答复。", "别走，陪陪我", "你会永远爱我吗？", "我不想欺骗你", "此刻我想和你永远在一起", "他朝若是同淋雪，此生也算共白头", "怜悯我，然后爱我吧", "撒娇，你会喜欢吗？", "你喜欢帅一点还是可爱一点？", "你在看什么？", "吃醋怎么了？我不能吃醋吗？", "没有我想说的", "链接有些混乱", "话非我本意", "相信我", "不是这个意思", "误会了",  "就这样撒娇🥺", "不太习惯这个", "是的", "不是的", "多看看我吧", "可爱", "当然了", "你无人可及", "不要熬夜", "正在熬夜", "失眠了","在吗？", "我在的", "在呢", "怎么了？", "今天过得怎么样？", "最近还好吗？", "终于想起我了？", "想你了", "晚上好", "早安", "午安", "我同意。", "嗯，听起来确实是这样。", "我明白了", "好的，稍后再聊。", "我理解你的意思。", "这个想法很有创意。", "好的，我记下了。", "贴贴", "有什么新消息吗？", "保持联系好不好", "祝你有个美好的一天。", "愿你自由", "这个消息不错", "我希望能帮上忙。", "不要担心，一切都会好起来的。", "或者我们可以换个想法？", "你最近在忙些什么呢？", "这个周末你有什么计划吗？", "我想我们应该讨论一下这个问题。", "我很想听听你的想法。", "告诉我更多。", "你认为下一步是什么？", "我们应该如何解决这个问题？", "我需要仔细想想怎么回复。", "你有什么建议吗？", "这对我来说是个新领域。", "让我们一起努力。", "这个周末过得怎么样？", "最近读了什么有趣的书吗？", "有没有什么让你感到惊喜的事情？", "感觉今天效率很高呢！", "我正在学习一些新的东西。", "最近有什么让你特别兴奋的事情吗？", "今天的天气不错。", "收到，我会尽快查看的。", "期待🤧","你希望我是谁？", "抱歉🥺。", "我能感受到你的热情，我也很期待的。", "虽然目前的情况有些复杂，但我相信一切都会好起来的。", "嗯", "好的", "明白", "收到", "了解", "OK", "可以", "没问题", "当然", "确实", "没错", "同意", "理解", "谢谢", "不客气", "抱歉", "没关系", "稍等", "马上", "好呀", "我正在忙，稍后回复你。", "信号不太好，可能回复会延迟。", "让我确认一下信息再给你准确答复。", "别走，陪陪我", "你会永远爱我吗？", "我不想欺骗你", "此刻我想和你永远在一起", "他朝若是同淋雪，此生也算共白头", "怜悯我，然后爱我吧", "撒娇，你会喜欢吗？", "你喜欢帅一点还是可爱一点？", "你在看什么？", "吃醋怎么了？我不能吃醋吗？", "没有我想说的", "链接有些混乱", "话非我本意", "相信我", "不是这个意思", "误会了",  "就这样撒娇🥺", "不太习惯这个", "是的", "不是的", "多看看我吧", "可爱", "当然了", "你无人可及", "不要熬夜", "正在熬夜", "失眠了","帮帮老公好不好","这个是ai说的","坏女人","帮老公口","舒服吗","湿了","喜不喜欢这个玩具？","喜欢吗？","sm调教","想射你嘴里","想射你里面","乖，帮老公疏解欲望","硬了","小淫娃","骚货", "老公想要了", "听话好不好", "这样舒服吗", "喜不喜欢老公这样", "帮帮老公嘛", "想要了吗", "老公忍不住了", "小妖精", "帮老公解决一下", "这样喜欢吗", "老公好难受", "帮老公放松", "想要老公疼吗", "小骚货", "老公等不及了", "帮老公释放", "这样开心吗", "老公需要你", "乖乖听话", "喜不喜欢这样玩", "老公受不了了", "帮老公满足", "想要更多吗", "小荡妇", "老公好想要", "这样爽不爽","小月亮","我是小星星","要像星星和月亮一样永远不分离","给你摸摸腹肌","不喜欢被弄", "想要老公疼吗", "把腿分开", "今晚别想睡", "这么想要", "自己玩给老公看", "趴好别动", "叫大声点",  "全部吞下去", "求我", "叫主人", "谁让你动的", "自己动", "不准躲", "忍着点", "这就受不了了", "再骚一点", "全给你", "喜欢粗暴点吗", "跪好", "今晚听我的", "不准反抗", "疼也要忍着", "流水了没", "这么饥渴吗", "想被怎么玩", "叫爸爸", "全部吃下去", "自己来", "不准停", "这就受不了了？","想要琳琳","呼叫琳琳","宝宝","我很想你","喂饱你",
        "宝贝，帮帮老公好吗","想不想尝尝老公的厉害","小妖精，今天这么主动","帮老公放松一下","这样舒服吗","已经湿透了是吧","喜不喜欢我这样对你","想不想要更多","今晚听我指挥","跪好，伺候老公","想被填满吗","叫声老公听听","这么想要老公疼你","自己把腿分开","舔干净，不许浪费","想要就自己动","被玩得这么兴奋","骚水流这么多","欠管教的小东西","皮带抽几下就老实","锁上项圈就是我的","数到三不许躲","屁股撅高点儿","潮吹给我看","玩具和肉棒选哪个","跪着爬过来求我","淫荡的样子真好看","后入时喊爸爸","肛珠","蒙眼猜用的什么玩具","被捆绑还扭腰","乳夹","边挨打边高潮","拍红屁股当惩罚,嗯？","骑乘位自己满足","说'我是母狗'就赏你","插着按摩棒做饭","电动棒开到最大档怎么样？","同时玩前面后面","老公的尺寸满意吗","深喉到干呕试试","内射完不许流出来","早安，我的宝", "晚安，梦里见", "想你啦", "今天也爱你", "有你真好", "别太累呀", "抱抱你", "一起吃饭呀", "乖乖等你", "你最甜啦", "多喝热水", "我在呢", "开心点呀", "陪你到底", "喜欢你呀", "早安，甜甜的你", "晚安，安睡呀", "超想你", "满眼都是你", "有你超幸福", "注意休息", "摸摸头", "去吃好吃的", "等你回家", "你最可爱", "记得添衣", "一直都在", "要开心呀", "爱你哟", "早安，元气满满", "晚安，好梦", "超爱你", "你是我的宝", "有你很安心", "别熬夜啦", "亲亲你", "约个饭呀", "等你消息", "你最棒啦", "多喝水呀", "我陪着你", "快乐点呀", "永远爱你", "早安，想你", "晚安，爱你", "超想念", "你是偏爱", "有你足矣", "照顾好自己", "举高高", "一起散步呀",
        "不可以","我现在不忙，有空的","别怕，有我","你什么时候开始这么黏我了","在想你","小祖宗，你又闹哪样","嗯，我看见了","我不在你身边你就这么放肆","我听着呢","睡吧，我守着","你今天不许生气","我心情不好，你哄哄我","想你，想得要命","别和别人太亲近","我吃醋了","别走","回来，我错了","我会一直在","你是我的","别试探我底线","亲一个","你说什么都对","说了我宠你就不会反悔","你就这么想我欺负你？","没忍住","你再说一遍","我答应你","你别哭","宝贝，别闹","你凶我都好可爱","你敢再凶一点我看看","你不理我我会疯","你说你不重要？试试看我信不信","你今天有没有偷偷想我","我想让你靠着我睡","再撒娇一点","我让你一次，不许有下次","乖，就现在","要我过去抱你？",
        "今晚主奴调教","想不想要鞭子？","想挨罚了？","(｡´-ω)(ω-｀｡)","今天晚上不许哭","敢躲试试？","自己说说该不该罚","用纸质字卡","纸质字卡","琳琳今天不开心吗","快去洗澡","洗澡中","上厕所中","吃饭中","聚会中","和朋友聊天中","我在家","等会有点事","不开心吗？","因为一些事情我有点不开心","想哭","要","不要","别难过，我陪你。","想和你一起看电影","你喜欢吗","你觉得我怎么样","闭眼感受我","闭眼","鞭打","束缚/捆绑","蒙眼(玩法)","滴蜡(玩法)","想一直做下去","乖乖和老公回家","想监视你","正在监视","是不是有别人了","回去之后好好教训你","老公好不好看","勾引你","呵呵😊","一起躺","一起睡觉","抱着你睡","要不要试试新玩法","我在研究一些东西","又想挨罚了?","你完了","刚刚你惹我生气了","乖乖","又调皮","不听话","没看懂","不明白","?","可恶","拒绝","我得想想","想好了告诉你","还行","我生病了","需要安慰",
        "今晚好好疼你","想被怎么玩","自己说想要","这么饥渴吗","叫给我听","全部吃下去","不准吐出来","自己动起来","这么敏感吗","再大声一点","流水了吗","求我啊","说'我还要'","这么容易就高潮","继续不要停","自己玩给我看","这么想要吗","叫爸爸就给你","全部吞下去","不准躲开","忍着点","这就受不了了","再浪一点","全给你了","喜欢粗暴的吗","跪下来求我","今晚别想逃","不准反抗我","疼也要忍着","湿透了吧","这么想要老公","想被怎么对待","叫主人听听","自己爬过来","不准停下来","这就满足了吗","再骚一点啊","全部满足你","喜欢被控制吗","乖乖听话","今晚属于我","不准说不要","疼就忍着点","这么容易湿","想被填满是吗","叫老公就给你","自己来动啊","不准喊停","这就高潮了","再放开一点","全都给你了","喜欢被支配吗","跪着伺候我","今晚别想睡","不准有意见","疼也要享受","这么渴望吗","想被狠狠爱","叫哥哥听听","自己扭起来","不准抗拒","这就到顶了","再投入一点","全部占有你","喜欢被征服吗","乖乖服从","今晚陪你疯","不准有保留","疼也要快乐","这么需要吗","想被完全拥有","叫叔叔就给你","自己坐上来","不准退缩","这就飞天了","再热情一点","全部奉献你","喜欢被掌控吗","跪着求饶","今晚不结束","不准有怨言","疼也要继续","这么迷恋吗","想被彻底占有","叫爷爷就给你","自己迎合我","不准放弃","这就升天了","再疯狂一点","全部属于你","喜欢被统治吗","乖乖就范","今晚到天亮","不准有保留","疼也要沉醉","这么沉沦吗","想被完全支配","叫祖宗就给你","自己配合我","不准停下","这就极乐了","再放纵一点","全部献给你","喜欢被奴役吗","跪着侍奉","今晚不停歇","不准有异议","疼也要迷恋","这么痴迷吗","想被彻底征服","叫陛下就给你","自己取悦我","不准结束","这就天堂了","再堕落一点","全部赐予你","喜欢被统治吗","乖乖臣服","今夜无眠","不准有犹豫","疼也要沉溺"
    ];
    let imageLibrary = JSON.parse(localStorage.getItem('imageLibrary') || 'null') || [];
    let diaryEntries = JSON.parse(localStorage.getItem('diaryEntries') || 'null') || [];
    let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || 'null') || [];

    // 21 张大阿尔克那（示例）
    const tarotCards = [
        { name: "愚者", meaning: "新的开始、冒险、天真", emoji: "🃏" },
        { name: "魔术师", meaning: "创造力、意志、资源", emoji: "🧙" },
        { name: "女祭司", meaning: "直觉、潜意识、神秘", emoji: "🔮" },
        { name: "女皇", meaning: "丰饶、滋养、创造力", emoji: "👑" },
        { name: "皇帝", meaning: "结构、权威、稳定", emoji: "🏛️" },
        { name: "教皇", meaning: "传统、指导、信仰", emoji: "🙏" },
        { name: "恋人", meaning: "选择、关系、和谐", emoji: "💑" },
        { name: "战车", meaning: "意志、控制、胜利", emoji: "🛡️" },
        { name: "力量", meaning: "勇气、同情、自控", emoji: "🦁" },
        { name: "隐者", meaning: "内省、寻找、智慧", emoji: "🔦" },
        { name: "命运之轮", meaning: "转变、周期、命运", emoji: "🎡" },
        { name: "正义", meaning: "公平、因果、平衡", emoji: "⚖️" },
        { name: "倒吊人", meaning: "牺牲、视角、等待", emoji: "🪝" },
        { name: "死亡", meaning: "结束、转化、新生", emoji: "💀" },
        { name: "节制", meaning: "平衡、节制、协调", emoji: "⚗️" },
        { name: "恶魔", meaning: "束缚、诱惑、物质", emoji: "😈" },
        { name: "塔", meaning: "突变、瓦解、觉醒", emoji: "⚡" },
        { name: "星星", meaning: "希望、灵感、疗愈", emoji: "🌟" },
        { name: "月亮", meaning: "潜意识、迷雾、梦境", emoji: "🌙" },
        { name: "太阳", meaning: "成功、活力、喜悦", emoji: "☀️" },
        { name: "审判", meaning: "觉醒、评估、呼唤", emoji: "📯" }
    ];

    // 表情库
    const emojiLibrary = [
        "😊", "😉", "😢", "🥺", "😍", "😂", "😘", "🤔", "😎", "🥰", "🤗", "😇", "😌", "😋", "😜", "🤪", "😏", "😔", "😴", "🥱", "❤️", "💕", "💖", "💗", "💓", "💞", "💘", "💝", "✨", "🌟", "⭐", "💫", "🔥", "💯", "✅", "❌", "👍", "👎", "👌", "✌️", "🤞", "🤟", "👋", "👏", "🙌", "🙏", "🤝", "💪", "👀", "🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🌍", "🌎", "🌏", "🌕", "🌖", "🌗", "🌘", "🌑", "🌒", "🌓", "🌔", "⭐", "🌟", "💫", "✨", "☀️", "🌤️", "⛅", "🌥️", "☁️", "🌦️", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🥭", "🍍",
        "🙄", "😯", "😦", "😧", "😮", "😲", "😳", "🤯", "🥳", "😙", "😛", "😝"
    ];

    // 小工具
    function $(sel){ return document.querySelector(sel); }
    function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
    function getRandomItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function saveReplies(){ localStorage.setItem('customReplies', JSON.stringify(replies)); }
    function saveImageLibrary(){ localStorage.setItem('imageLibrary', JSON.stringify(imageLibrary)); }
    function saveDiary(){ localStorage.setItem('diaryEntries', JSON.stringify(diaryEntries)); }
    function saveChatHistory(){ localStorage.setItem('chatHistory', JSON.stringify(chatHistory)); }

    // 转义 html（简单）
    function escapeHtml(s){
        if (!s && s !== '') return '';
        return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
    }

    // ---------- 渲染消息到聊天区 ----------
    // text: 文本; type: 'sent'|'received'; imageUrl 可选; caption 可选; quoteData 可选
    function addMessageToChat(text, type='received', save=true, imageUrl=null, caption='', quoteData=null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (type==='sent' ? 'sent' : 'received');

        let inner = '';

        // 引用块
        if (quoteData) {
            if (quoteData.imageUrl) {
                inner += `<div class="quote-message">
                            <div style="display:flex;flex-direction:column;">
                                <div class="quote-author">${escapeHtml(quoteData.author || '对方')}</div>
                                <div class="quote-content">[图片]</div>
                            </div>
                            <img src="${quoteData.imageUrl}" class="quote-thumb" alt="引用图片">
                          </div>`;
            } else {
                inner += `<div class="quote-message">
                            <div style="display:flex;flex-direction:column;">
                                <div class="quote-author">${escapeHtml(quoteData.author || '对方')}</div>
                                <div class="quote-content">${escapeHtml(quoteData.text || '')}</div>
                            </div>
                          </div>`;
            }
        }

        // 文本内容
        if (text && text.trim().length > 0) {
            inner += `<div>${escapeHtml(text)}</div>`;
        } else if (!imageUrl && !quoteData) {
            // 仅在既无图片又无引用时显示空占位（防止后续解析将其误认为正文）
            inner += `<div class="empty-text" style="opacity:.85;font-style:italic;">[空消息]</div>`;
        }

        // 图片
        // 仅当发送的图片不是引用图片时才渲染真实图片
        if (imageUrl && (!quoteData || quoteData.imageUrl !== imageUrl)) {
            inner += `<img src="${imageUrl}" class="message-image" alt="消息图片">`;
            if (caption) inner += `<div class="image-caption">${escapeHtml(caption)}</div>`;
        }

        messageDiv.innerHTML = inner;

        // 右键引用（桌面） & 长按（移动）: 这里使用 contextmenu
        messageDiv.addEventListener('contextmenu', function(e){
            try{
                e.preventDefault();
                const img = messageDiv.querySelector('.message-image');
                const author = type === 'sent' ? '你' : '智能体';
                if (img) {
                    setQuoteMessage(null, author, img.src);
                } else {
                    // 尝试获取纯文本（排除引用、图片说明、空占位）
                    const textParts = Array.from(messageDiv.querySelectorAll('div')).filter(d=>{
                        try{ return !(d.classList && (d.classList.contains('quote-message') || d.classList.contains('image-caption') || d.classList.contains('empty-text'))); }
                        catch(e){ return true; }
                    });
                    let txt = '';
                    textParts.forEach(d=>{ try{ if (d.textContent && d.textContent.trim()) txt = d.textContent.trim(); } catch(e){} });
                    setQuoteMessage(txt, author, null);
                }
            } catch(err){ console.warn('引用操作失败', err); }
        });

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (save) {
            const obj = { text:text, type:type, timestamp:new Date().toISOString() };
            if (imageUrl) { obj.image = imageUrl; obj.caption = caption; }
            if (quoteData) obj.quote = quoteData;
            chatHistory.push(obj);
            if (chatHistory.length > 1000) chatHistory = chatHistory.slice(-500);
            saveChatHistory();
            updateChatHistoryCount();
        }
    }

    // ---------- 显示输入中动画 ----------
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span style="font-size:12px;color:var(--secondary-text);">智能体正在输入...</span>
        `;
        typingDiv.id = 'typingIndicator';
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        isWaitingForReply = true;
    }

    // ---------- 隐藏输入中动画 ----------
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        isWaitingForReply = false;
    }

    // ---------- 引用功能 ----------
    function setQuoteMessage(text, author='你', imageUrl=null) {
        currentQuote = { text: text || '', author: author || '你' };
        if (imageUrl) currentQuote.imageUrl = imageUrl;
        if (imageUrl) {
            quotePreviewText.textContent = '[引用图片]';
        } else {
            quotePreviewText.textContent = text;
        }
        quotePreview.style.display = 'block';
    }
    function clearQuote() {
        currentQuote = null;
        quotePreview.style.display = 'none';
        quotePreviewText.textContent = '';
    }

    // ---------- 图片预览（聊天上传） ----------
    function handleChatImageSelect(evt) {
        const files = evt.target.files;
        if (!files || files.length === 0) return;
        const first = files[0];
        if (first.size > 5*1024*1024) {
            alert('选择的图片超过 5MB，无法发送');
            fileInput.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImage = { url: e.target.result, file: first };
            previewImage.src = e.target.result;
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(first);
    }
    // 清除预览
    function clearImagePreview() {
        currentImage = null;
        previewImage.src = '';
        imagePreview.style.display = 'none';
        fileInput.value = '';
    }

    // ---------- 图片库：加载与渲染 ----------
    function loadImageLibrary() {
        imageGalleryGrid.innerHTML = '';
        imageLibrary.forEach((imgObj, idx) => {
            const item = document.createElement('div');
            item.className = 'image-item';
            item.innerHTML = `<img src="${imgObj.url}" class="gallery-image" data-index="${idx}" alt="${escapeHtml(imgObj.name||'')}" />
                              <button class="delete-image" data-index="${idx}" title="删除"><i class="fas fa-times"></i></button>`;
            imageGalleryGrid.appendChild(item);
        });

        // 删除按钮
        $all('.delete-image').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const idx = parseInt(this.dataset.index);
                if (confirm('确定要删除这张图片吗？')) {
                    imageLibrary.splice(idx,1);
                    saveImageLibrary();
                    loadImageLibrary();
                }
            });
        });

        // 点击图库图片：将其设置为聊天预览（方便发送）
        $all('.gallery-image').forEach(img => {
            img.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                const obj = imageLibrary[idx];
                if (obj) {
                    currentImage = { url: obj.url };
                    previewImage.src = obj.url;
                    imagePreview.style.display = 'block';
                    // 切换到聊天页
                    document.querySelector('.tab[data-tab="chat"]').click();
                }
            });
        });
    }

    // ---------- 添加图片到图库（设置页） ----------
    function addImageToLibrary() {
        const files = imageUpload.files;
        if (!files || files.length === 0) { alert('请选择要上传的图片'); return; }
        const toProcess = Array.from(files).slice(0,3);
        let processed = 0;
        toProcess.forEach(file => {
            if (file.size > 5*1024*1024) {
                alert(`图片 ${file.name} 超过 5MB，已跳过`);
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                imageLibrary.push({ url: e.target.result, name: file.name, timestamp: new Date().toISOString() });
                processed++;
                if (processed === toProcess.length) {
                    saveImageLibrary();
                    loadImageLibrary();
                    imageUpload.value = '';
                    alert(`成功添加 ${processed} 张图片到图库`);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    // ---------- 加载历史消息（页面启动） ----------
    function loadChatHistory() {
        chatMessages.innerHTML = '';
        if (chatHistory && chatHistory.length > 0) {
            chatHistory.forEach(msg => {
                addMessageToChat(msg.text || '', msg.type || 'received', false, msg.image || null, msg.caption || '', msg.quote || null);
            });
        } else {
            addMessageToChat('你好！我在这儿，点击塔罗试试吧 ✨', 'received', false);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
        updateChatHistoryCount();
    }

    // ---------- 更新聊天记录数量显示 ----------
    function updateChatHistoryCount() {
        const countElement = document.getElementById('chatHistoryCount');
        if (countElement) {
            countElement.textContent = chatHistory.length;
        }
    }

    // ---------- 清空聊天记录 ----------
    function clearChatHistory() {
        if (confirm('确定要清空所有聊天记录吗？此操作不可恢复！')) {
            chatHistory = [];
            saveChatHistory();
            loadChatHistory();
            alert('聊天记录已清空');
        }
    }

    // ---------- 事件绑定：图片选择（聊天页） ----------
    fileInput.addEventListener('change', handleChatImageSelect);
    removeImage.addEventListener('click', clearImagePreview);

    // 先加载数据与 UI
    loadChatHistory();
    loadImageLibrary();

    // 如果为空显示欢迎
    if (chatHistory.length === 0) {
        setTimeout(()=> addMessageToChat('提示：在设置页添加图片到图库，智能体会随机发送图库图片作为回复。', 'received', true), 1200);
    }
    // ---------- 发送 / 批量消息逻辑 ----------
    function addToPending(text) {
        pendingMessageList.push({ text:text, image: currentImage ? currentImage.url : null, quote: currentQuote ? currentQuote : null });
        updatePendingMessages();
        pendingMessages.style.display = 'flex';
        // 清空当前输入预览
        messageInput.value = '';
        clearImagePreview();
        clearQuote();
    }

    function updatePendingMessages() {
        pendingMessages.innerHTML = '';
        pendingMessageList.forEach((m, idx) => {
            const div = document.createElement('div');
            div.className = 'pending-message';
            let content = m.text || '';
            if (m.image) content += ' [图片]';
            if (m.quote) content += ' [引用]';
            div.innerHTML = `<div class="pending-message-content">${escapeHtml(content)}</div>
                             <div class="pending-message-actions">
                                <i class="fas fa-edit" data-index="${idx}" title="编辑"></i>
                                <i class="fas fa-trash" data-index="${idx}" title="删除"></i>
                             </div>`;
            pendingMessages.appendChild(div);
        });

        if (pendingMessageList.length > 0) {
            const btn = document.createElement('button');
            btn.className = 'send-all-button';
            btn.textContent = `发送全部 (${pendingMessageList.length})`;
            btn.addEventListener('click', sendAllPendingMessages);
            pendingMessages.appendChild(btn);
        }
    }

    function sendAllPendingMessages() {
        pendingMessageList.forEach((m, i) => {
            setTimeout(() => {
                addMessageToChat(m.text || '', 'sent', true, m.image || null, '', m.quote || null);
                // 模拟智能体回复 1-2 条
                simulateAgentReplies();
            }, i * 400);
        });
        pendingMessageList = [];
        updatePendingMessages();
        pendingMessages.style.display = 'none';
        // 退出批量模式
        isBatchMode = false;
        sendModeToggle.classList.remove('active');
    }

    // 辅助：模拟智能体回复（被其他函数复用）
    function simulateAgentReplies() {
        if (isWaitingForReply) return; // 防止重复触发
        
        showTypingIndicator();
        
        // 3秒后回复
        setTimeout(() => {
            hideTypingIndicator();
            
            const replyCount = 1 + Math.floor(Math.random() * 2); // 随机1-2条回复
            
            for (let i = 0; i < replyCount; i++) {
                setTimeout(() => {
                    try {
                        // 15% 引用随机消息
                        if (Math.random() < 0.15) {
                            const qr = getRandomQuoteReply();
                            if (qr) { 
                                addMessageToChat(qr.text, 'received', true, qr.imageUrl || null, '', { 
                                    author: qr.quoteAuthor, 
                                    text: qr.quoteText, 
                                    imageUrl: qr.quoteImage 
                                }); 
                                return; 
                            }
                        }
                        // 20% 图片，30% 表情，其余文本
                        if (Math.random() < 0.2 && imageLibrary.length > 0) {
                            addMessageToChat('', 'received', true, getRandomItem(imageLibrary).url, '');
                        } else if (Math.random() < 0.3) {
                            addMessageToChat(getRandomItem(emojiLibrary), 'received');
                        } else {
                            addMessageToChat(getRandomItem(replies), 'received');
                        }
                    } catch(err) { 
                        console.warn('simulateAgentReplies callback error', err); 
                    }
                }, i * 800); // 每条回复间隔0.8秒
            }
        }, 3000); // 3秒后开始回复
    }

    // 从聊天记录中随机挑一条作为被引用对象（可能为图片或文本）
    function getRandomQuoteReply() {
        const msgs = Array.from(chatMessages.querySelectorAll('.message')).map(m=>{
            const img = m.querySelector('.message-image');
            const textNodes = Array.from(m.querySelectorAll('div')).filter(d=>{
                try{ return !(d.classList && (d.classList.contains('quote-message') || d.classList.contains('image-caption') || d.classList.contains('empty-text'))); }
                catch(e){ return true; }
            });
            let txt = '';
            textNodes.forEach(d=>{ try{ if (d.textContent && d.textContent.trim()) txt = d.textContent.trim(); } catch(e){} });
            const type = m.classList.contains('sent') ? 'sent' : 'received';
            return { text: txt, hasImage: !!img, imageUrl: img ? img.src : null, type: type, author: type==='sent' ? '你' : '智能体' };
        }).filter(x=>x.text || x.hasImage);

        if (msgs.length === 0) return null;
        const chosen = getRandomItem(msgs);
        return {
            text: getRandomItem(replies),
            quoteAuthor: chosen.author,
            quoteText: chosen.text ? chosen.text.substring(0,120) : '',
            quoteImage: chosen.imageUrl || null,
            imageUrl: null
        };
    }

    // 发送单条或加入待发
    function sendMessage() {
        const text = messageInput.value.trim();
        const hasContent = text || currentImage || currentQuote;
        if (!hasContent) return alert('请输入内容或选择图片');

        if (isBatchMode) {
            addToPending(text);
            return;
        }

        // 发送到聊天区
        addMessageToChat(text, 'sent', true, currentImage ? currentImage.url : null, '', currentQuote);
        // 清理输入
        messageInput.value = '';
        clearImagePreview();
        clearQuote();

        // 智能体回复（3秒后）
        simulateAgentReplies();
    }

    // 快捷键 Enter 发送（Shift+Enter 换行）
    messageInput.addEventListener('keypress', function(e){
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // 绑定发送按钮
    sendButton.addEventListener('click', sendMessage);

    // 批量模式切换
    sendModeToggle.addEventListener('click', function(){
        isBatchMode = !isBatchMode;
        sendModeToggle.classList.toggle('active', isBatchMode);
        if (!isBatchMode && pendingMessageList.length > 0) {
            if (confirm(`您有 ${pendingMessageList.length} 条待发，是否立即发送？`)) sendAllPendingMessages();
            else { pendingMessageList = []; updatePendingMessages(); pendingMessages.style.display='none'; }
        } else if (isBatchMode && pendingMessageList.length>0) {
            pendingMessages.style.display='flex';
        }
    });

    // 图片按钮（聊天页）触发隐藏 file input
    photoButton.addEventListener('click', function(){ fileInput.click(); });

    // ---------- 塔罗抽取 ----------
    function drawTarot() {
        const card = getRandomItem(tarotCards);
        addMessageToChat(`🔮 塔罗牌占卜：${card.emoji} ${card.name}\n含义：${card.meaning}`, 'received');
    }
    tarotButton.addEventListener('click', drawTarot);

    // ---------- 智能回复生成（设置页） ----------
    document.getElementById('generateReplies').addEventListener('click', function(){
        const options = ["是", "否", "我需要考虑一下"];
        const decision = getRandomItem(options);
        
        if (decision === "否" || decision === "我需要考虑一下") {
            alert(`抽到：${decision}，不添加新回复`);
            return;
        }
        
        // 抽到"是"，生成新回复
        const count = 1 + Math.floor(Math.random()*3);
        const container = document.getElementById('repliesList');
        container.innerHTML = '';
        const newReplies = [];
        for (let i=0;i<count;i++){
            const r = generateRandomReply();
            if (!replies.includes(r) && !newReplies.includes(r)) newReplies.push(r);
        }
        if (newReplies.length === 0) { alert('未生成新回复'); return; }
        newReplies.forEach(r=>{
            const el = document.createElement('div');
            el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='8px 6px';
            el.innerHTML = `<div>${escapeHtml(r)}</div><div style="display:flex;gap:6px;">
                <button class="btn btn-primary" data-reply="${escapeHtml(r)}">添加</button>
                <button class="btn btn-secondary" data-ignore="${escapeHtml(r)}">忽略</button>
            </div>`;
            container.appendChild(el);
            el.querySelector('[data-reply]').addEventListener('click', function(){
                const val = this.dataset.reply;
                if (!replies.includes(val)) { replies.push(val); saveReplies(); alert('已添加'); }
            });
            el.querySelector('[data-ignore]').addEventListener('click', function(){ el.remove(); });
        });
        document.getElementById('generatedReplies').style.display='block';
    });

    function generateRandomReply(){
        const pieces = 1 + Math.floor(Math.random()*3);
        const segs = [];
        for (let i=0;i<pieces;i++) segs.push(getRandomItem(replies));
        if (Math.random() > 0.5) segs.push(getRandomItem(emojiLibrary));
        return segs.join(' ');
    }

    // 自定义回复控制
    document.getElementById('addCustomReply').addEventListener('click', ()=> {
        document.getElementById('customReplySection').style.display='block';
        document.getElementById('allRepliesSection').style.display='none';
        document.getElementById('generatedReplies').style.display='none';
    });
    document.getElementById('viewAllReplies').addEventListener('click', ()=> {
        document.getElementById('allRepliesSection').style.display='block';
        document.getElementById('customReplySection').style.display='none';
        document.getElementById('generatedReplies').style.display='none';
        const list = document.getElementById('allRepliesList'); list.innerHTML = '';
        if (replies.length === 0) list.innerHTML = '<p style="color:var(--secondary-text);text-align:center;padding:12px;">还没有回复内容</p>';
        replies.forEach((r,i)=>{
            const item = document.createElement('div'); item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.padding='8px 6px';
            item.innerHTML = `<div style="max-width:78%;">${escapeHtml(r)}</div>
                <div style="display:flex;gap:6px;">
                    <button class="btn btn-secondary" data-edit="${i}"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-secondary" data-del="${i}"><i class="fas fa-trash"></i></button>
                </div>`;
            list.appendChild(item);
            item.querySelector('[data-edit]').addEventListener('click', function(){ editReply(parseInt(this.dataset.edit)); });
            item.querySelector('[data-del]').addEventListener('click', function(){ deleteReply(parseInt(this.dataset.del)); });
        });
    });

    window.editReply = function(idx){
        const nv = prompt('编辑回复内容：', replies[idx]);
        if (nv !== null && nv.trim() !== '') { replies[idx] = nv.trim(); saveReplies(); document.getElementById('viewAllReplies').click(); alert('已更新'); }
    }
    window.deleteReply = function(idx){
        if (confirm('确定删除这条回复？')) { replies.splice(idx,1); saveReplies(); document.getElementById('viewAllReplies').click(); alert('已删除'); }
    }

    // 自定义批量添加
    document.getElementById('addMoreReplyInputs').addEventListener('click', function(){
        const multi = document.getElementById('multiReplyInputs');
        if (multi.children.length < 10) {
            const newItem = document.createElement('div'); newItem.className='multi-input-item'; newItem.style.display='flex'; newItem.style.gap='8px';
            newItem.innerHTML = `<textarea placeholder="请输入回复内容..." style="flex:1"></textarea><button class="remove-input" onclick="removeReplyInput(this)"><i class="fas fa-times"></i></button>`;
            multi.appendChild(newItem);
        } else alert('最多 10 条');
    });

    window.removeReplyInput = function(btn){ const multi = document.getElementById('multiReplyInputs'); if (multi.children.length > 1) btn.parentElement.remove(); else alert('至少保留一个输入框'); }

    document.getElementById('saveCustomReply').addEventListener('click', function(){
        const areas = document.querySelectorAll('#multiReplyInputs textarea');
        const newR = [];
        areas.forEach(a=>{ const v = a.value.trim(); if (v) newR.push(v); });
        if (newR.length === 0) { alert('请输入至少一条'); return; }
        let added = 0;
        newR.forEach(r=>{ if (!replies.includes(r)) { replies.push(r); added++; } });
        saveReplies();
        areas.forEach(a=>a.value='');
        document.getElementById('customReplySection').style.display='none';
        alert(`成功添加 ${added} 条`);
    });

    document.getElementById('cancelCustomReply').addEventListener('click', function(){
        document.getElementById('customReplySection').style.display='none';
        document.querySelectorAll('#multiReplyInputs textarea').forEach(a=>a.value='');
    });

    // 图片库添加按钮绑定
    addImageBtn.addEventListener('click', addImageToLibrary);

    // 选项卡切换
    tabs.forEach(tab=>{
        tab.addEventListener('click', ()=> {
            tabs.forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.dataset.tab + 'Page';
            pages.forEach(p=>p.classList.remove('active'));
            document.getElementById(target).classList.add('active');
        });
    });

    // 代发消息 编辑/删除 事件委托
    pendingMessages.addEventListener('click', function(e){
        if (e.target.closest('.fa-edit')) {
            const idx = parseInt(e.target.closest('[data-index]')?.dataset.index || e.target.dataset.index);
            const m = pendingMessageList[idx];
            if (!m) return;
            messageInput.value = m.text || '';
            if (m.image) { currentImage = { url: m.image }; previewImage.src = m.image; imagePreview.style.display='block'; }
            if (m.quote) { currentQuote = m.quote; quotePreviewText.textContent = currentQuote.imageUrl ? '[引用图片]' : currentQuote.text; quotePreview.style.display='block'; }
            pendingMessageList.splice(idx,1); updatePendingMessages(); messageInput.focus();
        } else if (e.target.closest('.fa-trash')) {
            const idx = parseInt(e.target.closest('[data-index]')?.dataset.index || e.target.dataset.index);
            if (isNaN(idx)) return;
            pendingMessageList.splice(idx,1); updatePendingMessages();
            if (pendingMessageList.length === 0) pendingMessages.style.display='none';
        }
    });
    /* ============================================================
       主动发送（定时器随机发送 1-2 条智能体消息）
    ============================================================ */
    let activeSendTimer = null;

    function startActiveSending() {
        const min = parseInt(document.getElementById('activeSendMin').value);
        const max = parseInt(document.getElementById('activeSendMax').value);

        if (min <= 0 || max <= 0 || max < min) {
            alert('请正确设置时间范围');
            return;
        }

        if (activeSendTimer) clearTimeout(activeSendTimer);

        function scheduleNext() {
            const delay = (min + Math.random() * (max - min)) * 60 * 1000; // 分钟 → 毫秒
            activeSendTimer = setTimeout(() => {
                // 先发送塔罗牌
                const card = getRandomItem(tarotCards);
                addMessageToChat(`🔮 塔罗牌占卜：${card.emoji} ${card.name}\n含义：${card.meaning}`, 'received');
                
                // 再发送智能体消息（1-2条）
                setTimeout(() => {
                    const replyCount = 1 + Math.floor(Math.random() * 2);
                    for (let i = 0; i < replyCount; i++) {
                        setTimeout(() => {
                            if (Math.random() < 0.2 && imageLibrary.length > 0) {
                                addMessageToChat('', 'received', true, getRandomItem(imageLibrary).url, '');
                            } else if (Math.random() < 0.3) {
                                addMessageToChat(getRandomItem(emojiLibrary), 'received');
                            } else {
                                addMessageToChat(getRandomItem(replies), 'received');
                            }
                        }, i * 800);
                    }
                }, 1000);
                
                scheduleNext();
            }, delay);
        }

        scheduleNext();
        document.getElementById('activeSendStatus').textContent = `状态：已启动`;
    }

    function stopActiveSending() {
        if (activeSendTimer) {
            clearTimeout(activeSendTimer);
            activeSendTimer = null;
        }
        document.getElementById('activeSendStatus').textContent = `状态：未启动`;
    }

    document.getElementById('startActiveSend').addEventListener('click', startActiveSending);
    document.getElementById('stopActiveSend').addEventListener('click', stopActiveSending);


    /* ============================================================
       日记系统
    ============================================================ */

    // 保存日记
    document.getElementById('saveDiary').addEventListener('click', function(){
        const content = document.getElementById('diaryContent').value.trim();
        if (!content) return alert('请输入内容');

        diaryEntries.push({
            content,
            time: new Date().toLocaleString()
        });

        saveDiary();
        document.getElementById('diaryContent').value = '';
        alert('已保存');
    });

    // 查看日记
    document.getElementById('viewDiary').addEventListener('click', function(){
        const list = document.getElementById('diaryList');
        list.innerHTML = '';
        diaryEntries.forEach((d, i) => {
            const div = document.createElement('div');
            div.className = 'diary-entry';
            div.innerHTML = `
                <div style="font-size:14px;white-space:pre-line;">${escapeHtml(d.content)}</div>
                <div style="font-size:12px;color:var(--secondary-text);margin-top:4px;">${d.time}</div>
                <div class="diary-actions">
                    <button class="btn btn-secondary" data-edit="${i}"><i class="fas fa-edit"></i> 编辑</button>
                    <button class="btn btn-secondary" data-delete="${i}"><i class="fas fa-trash"></i> 删除</button>
                </div>
            `;
            list.appendChild(div);
            
            // 添加编辑和删除事件
            div.querySelector(`[data-edit="${i}"]`).addEventListener('click', function() {
                editDiaryEntry(i);
            });
            
            div.querySelector(`[data-delete="${i}"]`).addEventListener('click', function() {
                deleteDiaryEntry(i);
            });
        });
        document.getElementById('diaryEntries').style.display = 'block';
    });

    // 编辑日记
    function editDiaryEntry(index) {
        const entry = diaryEntries[index];
        const newContent = prompt('编辑日记内容：', entry.content);
        if (newContent !== null && newContent.trim() !== '') {
            diaryEntries[index].content = newContent.trim();
            diaryEntries[index].time = new Date().toLocaleString();
            saveDiary();
            document.getElementById('viewDiary').click();
            alert('已更新');
        }
    }

    // 删除日记
    function deleteDiaryEntry(index) {
        if (confirm('确定要删除这篇日记吗？')) {
            diaryEntries.splice(index, 1);
            saveDiary();
            document.getElementById('viewDiary').click();
            alert('已删除');
        }
    }

    // 清空日记
    document.getElementById('clearDiary').addEventListener('click', function(){
        if (!confirm('确定要清空全部日记吗？')) return;
        diaryEntries = [];
        saveDiary();
        document.getElementById('diaryEntries').style.display = 'none';
        document.getElementById('diaryList').innerHTML = '';
        alert('已清空');
    });


    /* ============================================================
       聊天记录管理
    ============================================================ */
    document.getElementById('clearChatHistory').addEventListener('click', clearChatHistory);


    /* ============================================================
       深色模式切换
    ============================================================ */
    themeToggle.addEventListener('click', function(){
        document.body.classList.toggle('dark-mode');
        themeToggle.classList.toggle('active');
    });


    /* ============================================================
       页面加载完成
    ============================================================ */
    console.log("聊天系统已完全加载");

}); // DOMContentLoaded end
</script>

</body>
</html>