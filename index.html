<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä¼ è®¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ä¿æŒåŸæœ‰CSSæ ·å¼ä¸å˜ */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        :root {
            --primary-color: #6a6a6a;
            --secondary-color: #3f3f3f;
            --background-color: #f7f9fc;
            --container-color: #ffffff;
            --header-color: #f0f2f5;
            --input-color: #ffffff;
            --sent-msg-color: #6a6a6a;
            --received-msg-color: #e2eaf0;
            --text-color: #333333;
            --secondary-text: #888888;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);
        }

        body.dark-mode {
            --background-color: #1a1a1a;
            --container-color: #2d2d2d;
            --header-color: #3d3d3d;
            --input-color: #2d2d2d;
            --sent-msg-color: #4a4a4a;
            --received-msg-color: #3a3a3a;
            --text-color: #e0e0e0;
            --secondary-text: #a0a0a0;
            --border-color: #444444;
        }
        
        body {
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            transition: background-color 0.3s ease;
        }
        
        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 700px;
            background-color: var(--container-color);
            border-radius: 20px;
            box-shadow: 0 12px 40px var(--shadow-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .tab-container {
            display: flex;
            background-color: var(--header-color);
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--secondary-text);
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: var(--container-color);
        }
        
        .page {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .page.active {
            display: flex;
        }
        
        /* èŠå¤©é¡µé¢æ ·å¼ */
        .chat-header {
            background-color: var(--header-color);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            margin-right: 14px;
        }
        
        .user-info h3 {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 2px;
        }
        
        .user-info p {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 18px;
        }
        
        .header-actions i {
            color: var(--secondary-text);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .header-actions i:hover {
            color: var(--primary-color);
            background-color: rgba(0,0,0,0.05);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: var(--background-color);
        }
        
        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .received {
            align-self: flex-start;
            background-color: var(--received-msg-color);
        }
        
        .sent {
            align-self: flex-end;
            background-color: var(--sent-msg-color);
            color: white;
        }
        
        /* å¼•ç”¨æ¶ˆæ¯æ ·å¼ - æ”¹è¿› */
        .quote-message {
            background-color: rgba(0,0,0,0.08);
            padding: 10px 14px;
            border-radius: 14px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9em;
            opacity: 0.9;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quote-message:hover {
            background-color: rgba(0,0,0,0.12);
            transform: translateX(2px);
        }
        
        .quote-author {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quote-author::before {
            content: "â†³";
            font-size: 1.1em;
        }
        
        .quote-content {
            font-style: normal;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ä¿®å¤ï¼šå¼•ç”¨æ¶ˆæ¯ä¸­çš„å›¾ç‰‡æ ·å¼ */
        .quote-image {
            max-width: 100%;
            max-height: 80px;
            border-radius: 8px;
            margin-top: 5px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .image-caption {
            margin-top: 8px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .chat-input-container {
            border-top: 1px solid var(--border-color);
            background-color: var(--container-color);
        }
        
        .chat-input {
            padding: 14px 20px;
            display: flex;
            align-items: flex-end;
            gap: 14px;
        }
        
        .input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message-input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border-color);
            border-radius: 28px;
            background-color: var(--input-color);
            color: var(--text-color);
            outline: none;
            resize: none;
            max-height: 200px;
            min-height: 60px;
            font-family: inherit;
            transition: border-color 0.3s ease;
            font-size: 14px;
        }
        
        .message-input:focus {
            border-color: var(--primary-color);
        }
        
        /* å¼•ç”¨é¢„è§ˆ */
        .quote-preview {
            background-color: var(--header-color);
            padding: 10px 15px;
            border-radius: 15px;
            border-left: 3px solid var(--primary-color);
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .quote-preview-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .quote-preview-text {
            flex: 1;
            font-size: 0.9em;
            opacity: 0.8;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ä¿®å¤ï¼šå¼•ç”¨é¢„è§ˆä¸­çš„å›¾ç‰‡æ ·å¼ */
        .quote-preview-image {
            max-width: 60px;
            max-height: 60px;
            border-radius: 6px;
            margin-top: 5px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .cancel-quote {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
            transition: color 0.2s ease;
        }
        
        .cancel-quote:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }
        
        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            display: none;
            position: relative;
            max-width: 200px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 12px;
        }
        
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .remove-image:hover {
            transform: scale(1.1);
        }
        
        .send-button, .tarot-button, .active-send-button, .send-mode-toggle, .screenshot-button, .photo-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 18px;
            transition: all 0.2s ease;
            background-color: var(--header-color);
            color: var(--secondary-text);
        }
        
        .send-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .send-mode-toggle.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
        }
        
        .tarot-button:hover, .active-send-button:hover, .send-mode-toggle:hover, .screenshot-button:hover, .photo-button:hover {
            transform: scale(1.05);
            background-color: var(--primary-color);
            color: white;
        }
        
        /* å¾…å‘æ¶ˆæ¯åŒºåŸŸ */
        .pending-messages {
            background-color: var(--input-color);
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: none;
            flex-direction: column;
            gap: 10px;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .pending-message {
            background-color: var(--header-color);
            padding: 10px 14px;
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: messageAppear 0.3s ease-out;
        }
        
        .pending-message-content {
            flex-grow: 1;
            margin-right: 12px;
        }
        
        .pending-message-actions i {
            color: var(--secondary-text);
            cursor: pointer;
            margin-left: 8px;
            transition: color 0.3s ease;
        }
        
        .pending-message-actions i:hover {
            color: var(--primary-color);
        }
        
        .send-all-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            align-self: flex-end;
            margin-top: 12px;
            transition: all 0.2s ease;
        }
        
        .send-all-button:hover {
            transform: translateY(-2px);
        }
        
        /* è®¾ç½®é¡µé¢æ ·å¼ */
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--background-color);
        }
        
        .settings-section {
            background-color: var(--container-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .settings-section h3 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-section h3 i {
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-color);
            color: var(--text-color);
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .interval-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .interval-input-group input {
            width: 80px;
            text-align: center;
        }
        
        .interval-separator {
            color: var(--secondary-text);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background-color: #2E8B57;
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--header-color);
            color: var(--text-color);
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        /* ç”Ÿæˆçš„å›å¤æ ·å¼ */
        .generated-reply {
            background-color: var(--header-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reply-actions {
            display: flex;
            gap: 8px;
        }
        
        .reply-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .reply-action.add {
            background-color: #2E8B57;
            color: white;
        }
        
        .reply-action.ignore {
            background-color: var(--secondary-text);
            color: white;
        }
        
        /* æ—¥è®°æ ·å¼ */
        .diary-entry {
            background-color: var(--header-color);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .diary-date {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .diary-content {
            line-height: 1.5;
        }
        
        /* å›¾ç‰‡åº“æ ·å¼ */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .gallery-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .gallery-image:hover {
            transform: scale(1.05);
        }
        
        .image-item {
            position: relative;
        }
        
        .delete-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar,
        .settings-content::-webkit-scrollbar,
        .pending-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track,
        .settings-content::-webkit-scrollbar-track,
        .pending-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb,
        .settings-content::-webkit-scrollbar-thumb,
        .pending-messages::-webkit-scrollbar-thumb {
            background: var(--secondary-text);
            border-radius: 3px;
        }
        
        /* æˆªå›¾ç›¸å…³æ ·å¼ */
        .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .screenshot-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        
        .screenshot-preview img {
            max-width: 100%;
            border-radius: 5px;
        }
        
        .screenshot-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body { padding: 0; }
            .chat-container { 
                height: 100vh; 
                border-radius: 0; 
            }
            .chat-header, .chat-input { 
                padding: 12px 16px; 
            }
            .chat-messages { 
                padding: 16px; 
            }
            .message { 
                max-width: 90%; 
            }
            .settings-content { 
                padding: 16px; 
            }
            .button-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- åˆ†é¡µå¯¼èˆª -->
        <div class="tab-container">
            <div class="tab active" data-tab="chat">èŠå¤©</div>
            <div class="tab" data-tab="settings">è®¾å®šä¸æ—¥è®°</div>
        </div>

        <!-- èŠå¤©é¡µé¢ -->
        <div class="page active" id="chatPage">
            <div class="chat-header">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <h3 id="userName">ğ‘³ğ’ğ’—ğ’†</h3>
                    <p><span class="status-indicator"></span> <span id="userStatus">åœ¨çº¿</span></p>
                </div>
                <div class="header-actions">
                    <i class="fas fa-moon" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜"></i>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message received">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIä¼™ä¼´ï¼Œéšæ—¶ä¸ºä½ æœåŠ¡ ğŸŒŸ
                </div>
            </div>
            
            <!-- å¾…å‘æ¶ˆæ¯åŒºåŸŸ -->
            <div class="pending-messages" id="pendingMessages"></div>
            
            <div class="chat-input-container">
                <div class="chat-input">
                    <div class="input-area">
                        <!-- å¼•ç”¨é¢„è§ˆ -->
                        <div class="quote-preview" id="quotePreview">
                            <div class="quote-preview-content">
                                <div id="quotePreviewContent">
                                    <div class="quote-preview-text" id="quotePreviewText"></div>
                                    <img id="quotePreviewImage" class="quote-preview-image" style="display: none;">
                                </div>
                                <button class="cancel-quote" id="cancelQuote">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div class="image-preview" id="imagePreview">
                            <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                            <button class="remove-image" id="removeImage">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="3"></textarea>
                    </div>
                    <button class="photo-button" id="photoButton" title="å‘é€å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="tarot-button" id="tarotButton" title="æŠ½å–å¡”ç½—ç‰Œ">
                        <i class="fas fa-cards"></i>
                    </button>
                    <button class="active-send-button" id="activeSendButton" title="å¯¹æ–¹ä¸»åŠ¨å‘é€">
                        <i class="fas fa-magic"></i>
                    </button>
                    <button class="send-mode-toggle" id="sendModeToggle" title="æ‰¹é‡å‘é€æ¨¡å¼">
                        <i class="fas fa-layer-group"></i>
                    </button>
                    <button class="screenshot-button" id="screenshotButton" title="æˆªå›¾">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="send-button" id="sendMessageButton">
                        <i class="fas fa-paper-plane" id="sendIcon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div class="page" id="settingsPage">
            <div class="settings-content">
                <!-- äººç‰©è®¾å®š -->
                <div class="settings-section">
                    <h3><i class="fas fa-user-cog"></i> äººç‰©è®¾å®š</h3>
                    <div class="form-group">
                        <label>æ€§åˆ«</label>
                        <select id="characterGender">
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¹´é¾„</label>
                        <input type="number" id="characterAge" value="25" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>æ€§æ ¼ç‰¹ç‚¹</label>
                        <textarea id="characterPersonality">æ¸©æŸ”ä½“è´´ï¼Œå–„è§£äººæ„ï¼Œå…³å¿ƒä»–äººæ„Ÿå—</textarea>
                    </div>
                    <div class="form-group">
                        <label>ä¸æˆ‘çš„å…³ç³»</label>
                        <textarea id="characterRelationship">äº²å¯†çš„æœ‹å‹å…³ç³»ï¼Œå½¼æ­¤ä¿¡ä»»ï¼Œäº’ç›¸æ”¯æŒ</textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="saveCharacter">ä¿å­˜è®¾å®š</button>
                    </div>
                </div>

                <!-- å›å¤ç®¡ç† -->
                <div class="settings-section">
                    <h3><i class="fas fa-robot"></i> æ™ºèƒ½å›å¤ç”Ÿæˆ</h3>
                    <p style="margin-bottom: 16px; color: var(--secondary-text);">æ ¹æ®äººç‰©è®¾å®šæ™ºèƒ½ç”Ÿæˆç¬¦åˆæ€§æ ¼çš„æ–°å›å¤å†…å®¹</p>
                    <div class="button-group">
                        <button class="btn btn-success" id="generateReplies">ç”Ÿæˆæ–°å›å¤</button>
                        <button class="btn btn-secondary" id="addCustomReply">è‡ªå®šä¹‰æ·»åŠ å›å¤</button>
                    </div>
                    <div id="customReplySection" style="display: none; margin-top: 16px;">
                        <div class="form-group">
                            <label>æ–°å›å¤å†…å®¹</label>
                            <textarea id="customReplyInput" placeholder="è¯·è¾“å…¥è¦æ·»åŠ çš„å›å¤å†…å®¹..."></textarea>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" id="saveCustomReply">æ·»åŠ </button>
                            <button class="btn btn-secondary" id="cancelCustomReply">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div id="generatedReplies" style="display: none; margin-top: 16px;">
                        <h4>æ–°ç”Ÿæˆçš„å›å¤ï¼š</h4>
                        <div id="repliesList"></div>
                    </div>
                </div>

                <!-- å›¾ç‰‡åº“ç®¡ç† -->
                <div class="settings-section">
                    <h3><i class="fas fa-images"></i> æ™ºèƒ½ä½“å›¾ç‰‡åº“</h3>
                    <p style="margin-bottom: 16px; color: var(--secondary-text);">ä¸ºæ™ºèƒ½ä½“æ·»åŠ å¯å‘é€çš„å›¾ç‰‡</p>
                    <div class="form-group">
                        <label>ä¸Šä¼ å›¾ç‰‡</label>
                        <input type="file" id="imageUpload" accept="image/*" style="padding: 8px;">
                        <small style="color: var(--secondary-text); margin-top: 5px; display: block;">
                            æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡ 5MB
                        </small>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="addImage">æ·»åŠ å›¾ç‰‡</button>
                    </div>
                    <div id="imageGallery" style="margin-top: 16px;">
                        <h4>å›¾ç‰‡åº“ï¼š</h4>
                        <div class="image-gallery" id="imageGalleryGrid">
                            <!-- å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                </div>

                <!-- ä¸»åŠ¨å‘é€è®¾ç½® -->
                <div class="settings-section">
                    <h3><i class="fas fa-clock"></i> ä¸»åŠ¨å‘é€è®¾ç½®</h3>
                    <div class="form-group">
                        <label>ä¸»åŠ¨å‘é€é—´éš”èŒƒå›´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <div class="interval-input-group">
                            <input type="number" id="activeSendMin" value="2" min="1" max="60">
                            <span class="interval-separator">-</span>
                            <input type="number" id="activeSendMax" value="10" min="2" max="120">
                        </div>
                        <small style="color: var(--secondary-text); margin-top: 5px; display: block;">
                            å°†åœ¨è®¾å®šçš„æ—¶é—´èŒƒå›´å†…éšæœºé€‰æ‹©é—´éš”æ—¶é—´
                        </small>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="startActiveSend">å¼€å§‹ä¸»åŠ¨å‘é€</button>
                        <button class="btn btn-secondary" id="stopActiveSend">åœæ­¢ä¸»åŠ¨å‘é€</button>
                    </div>
                    <p id="activeSendStatus" style="margin-top: 12px; color: var(--secondary-text);">çŠ¶æ€ï¼šæœªå¯åŠ¨</p>
                </div>

                <!-- æ—¥è®°åŠŸèƒ½ -->
                <div class="settings-section">
                    <h3><i class="fas fa-book"></i> æ—¥è®°è®°å½•</h3>
                    <div class="form-group">
                        <label>æ—¥è®°å†…å®¹</label>
                        <textarea id="diaryContent" placeholder="è®°å½•ä»Šå¤©çš„å¿ƒæƒ…å’Œæƒ³æ³•..." style="min-height: 120px;"></textarea>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" id="saveDiary">ä¿å­˜æ—¥è®°</button>
                        <button class="btn btn-secondary" id="viewDiary">æŸ¥çœ‹æ—¥è®°</button>
                        <button class="btn btn-secondary" id="clearDiary">æ¸…ç©ºæ—¥è®°</button>
                    </div>
                    <div id="diaryEntries" style="display: none; margin-top: 16px;">
                        <h4>æ—¥è®°è®°å½•ï¼š</h4>
                        <div id="diaryList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆªå›¾é¢„è§ˆå¼¹çª— -->
    <div class="screenshot-overlay" id="screenshotOverlay">
        <div class="screenshot-preview">
            <img id="screenshotImage" src="" alt="èŠå¤©æˆªå›¾">
            <div class="screenshot-actions">
                <button class="btn btn-primary" id="downloadScreenshot">ä¸‹è½½å›¾ç‰‡</button>
                <button class="btn btn-secondary" id="closeScreenshot">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åŸºç¡€å˜é‡
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessageButton');
            const tarotButton = document.getElementById('tarotButton');
            const activeSendButton = document.getElementById('activeSendButton');
            const sendModeToggle = document.getElementById('sendModeToggle');
            const sendIcon = document.getElementById('sendIcon');
            const pendingMessages = document.getElementById('pendingMessages');
            const themeToggle = document.getElementById('themeToggle');
            const screenshotButton = document.getElementById('screenshotButton');
            const screenshotOverlay = document.getElementById('screenshotOverlay');
            const screenshotImage = document.getElementById('screenshotImage');
            const downloadScreenshot = document.getElementById('downloadScreenshot');
            const closeScreenshot = document.getElementById('closeScreenshot');
            const photoButton = document.getElementById('photoButton');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const removeImage = document.getElementById('removeImage');
            const quotePreview = document.getElementById('quotePreview');
            const quotePreviewText = document.getElementById('quotePreviewText');
            const quotePreviewImage = document.getElementById('quotePreviewImage');
            const cancelQuote = document.getElementById('cancelQuote');
            
            // ä¸»åŠ¨å‘é€ç›¸å…³å˜é‡
            let activeSendTimer = null;
            let isActiveSendRunning = false;
            
            // æ‰¹é‡å‘é€æ¨¡å¼çŠ¶æ€
            let isBatchMode = false;
            let pendingMessageList = [];
            
            // å½“å‰å¼•ç”¨æ¶ˆæ¯
            let currentQuote = null;
            // å½“å‰å›¾ç‰‡æ•°æ®
            let currentImage = null;
            
            // åˆ†é¡µåŠŸèƒ½
            const tabs = document.querySelectorAll('.tab');
            const pages = document.querySelectorAll('.page');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetPage = tab.dataset.tab;
                    
                    // æ›´æ–°æ´»è·ƒæ ‡ç­¾
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”é¡µé¢
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === targetPage + 'Page') {
                            page.classList.add('active');
                        }
                    });
                });
            });
            
            // ========== è¡¨æƒ…ç¬¦å·åº“ ==========
            const emojis = [
                "ğŸ˜Š", "ğŸ˜‰", "ğŸ˜¢", "ğŸ¥º", "ğŸ˜", "ğŸ˜‚", "ğŸ˜˜", "ğŸ¤”", "ğŸ˜", "ğŸ¥°", "ğŸ¤—", "ğŸ˜‡", "ğŸ˜Œ", "ğŸ˜‹", "ğŸ˜œ", "ğŸ¤ª", "ğŸ˜", "ğŸ˜”", "ğŸ˜´", "ğŸ¥±", "â¤ï¸", "ğŸ’•", "ğŸ’–", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’˜", "ğŸ’", "âœ¨", "ğŸŒŸ", "â­", "ğŸ’«", "ğŸ”¥", "ğŸ’¯", "âœ…", "âŒ", "ğŸ‘", "ğŸ‘", "ğŸ‘Œ", "âœŒï¸", "ğŸ¤", "ğŸ¤Ÿ", "ğŸ‘‹", "ğŸ‘", "ğŸ™Œ", "ğŸ™", "ğŸ¤", "ğŸ’ª", "ğŸ‘€", "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸŒ", "ğŸŒ", "ğŸŒ", "ğŸŒ•", "ğŸŒ–", "ğŸŒ—", "ğŸŒ˜", "ğŸŒ‘", "ğŸŒ’", "ğŸŒ“", "ğŸŒ”", "â­", "ğŸŒŸ", "ğŸ’«", "âœ¨", "â˜€ï¸", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "â˜ï¸", "ğŸŒ¦ï¸", "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸˆ", "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ"
            ];
            
            // ========== çŠ¶æ€é€‰é¡¹ ==========
            const statusOptions = [
                "åœ¨çº¿", "å¿™ç¢Œ", "æ‘¸é±¼", "æ€è€ƒ", "ä¼‘æ¯", "æ™’æœˆäº®", "æƒ³ä½ ", "æ™´å¤©","å¤šäº‘","æš´é›ª","é›¾å¤©","å°é›¨","ä¸­é›¨","æš´é›¨","å®‰å¿ƒ","æƒ†æ€…","å®ˆå€™","æƒŠè®¶","å‹æŠ‘","æ¸©æŸ”","ä¸èˆ","æ„§ç–š","æš—å–œ", "å·¥ä½œ", "å­¦ä¹ ", "å¥èº«", "æ¢ç´¢", "æ²‰æ€", "å†¥æƒ³", "é˜´å¤©", "å……ç”µä¸­","ç„¦ç¼","å–œæ‚¦","å¼€å¿ƒ","éš¾è¿‡","å¿®å¿Œ","å®‰é™","æ€€å¿µ","ç­‰å¾…","ç©ºè™š","å†·é™","æƒŠé†’","ç‰µæŒ‚","åšå®š","ä½ å¥½"
            ];
            
            // å›å¤åº“ - ä½¿ç”¨æ‚¨æä¾›çš„ä¸°å¯Œå›å¤å†…å®¹
            let replies = [
                "Hi", "ä½ å¥½å‘€", "åœ¨å‘¢", "æ€ä¹ˆäº†ï¼Ÿ", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ€è¿‘è¿˜å¥½å—ï¼Ÿ", "å¥½ä¹…ä¸è§ï¼", "æƒ³ä½ äº†", "æ™šä¸Šå¥½", "æ—©å®‰", "åˆå®‰", "æˆ‘åŒæ„ã€‚", "å—¯ï¼Œå¬èµ·æ¥ç¡®å®æ˜¯è¿™æ ·ã€‚", "æˆ‘æ˜ç™½äº†ï¼Œè°¢è°¢ä½ çš„è§£é‡Šã€‚", "å¥½çš„ï¼Œç¨åæˆ‘ä»¬å†èŠã€‚", "æˆ‘ç†è§£ä½ çš„æ„æ€ã€‚", "è¿™ä¸ªæƒ³æ³•å¾ˆæœ‰åˆ›æ„ã€‚", "å¥½çš„ï¼Œæˆ‘è®°ä¸‹äº†ã€‚", "è°¢è°¢ä½ çš„å…³å¿ƒã€‚", "å¾ˆé«˜å…´èƒ½å¸®åˆ°ä½ ï¼", "æœ‰ä»€ä¹ˆæ–°æ¶ˆæ¯å—ï¼Ÿ", "ä¿æŒè”ç³»ï¼", "ç¥ä½ æœ‰ä¸ªç¾å¥½çš„ä¸€å¤©ã€‚", "å¾ˆé«˜å…´å¬åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼", "æˆ‘å¸Œæœ›èƒ½å¸®ä¸Šå¿™ã€‚", "ä¸è¦æ‹…å¿ƒï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚", "ç¥ä½ å¥½è¿ï¼", "æˆ–è€…æˆ‘ä»¬å¯ä»¥æ¢ä¸ªæ€è·¯ï¼Ÿ", "ä½ æœ€è¿‘åœ¨å¿™äº›ä»€ä¹ˆå‘¢ï¼Ÿ", "è¿™ä¸ªå‘¨æœ«ä½ æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ", "æˆ‘æƒ³æˆ‘ä»¬åº”è¯¥è®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚", "æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•ã€‚", "å‘Šè¯‰æˆ‘æ›´å¤šã€‚", "ä½ è®¤ä¸ºä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ", "æˆ‘ä»¬åº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ", "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œæˆ‘éœ€è¦ä»”ç»†è€ƒè™‘ã€‚", "ä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ", "è¿™å¯¹æˆ‘æ¥è¯´æ˜¯ä¸ªæ–°é¢†åŸŸã€‚", "è®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›ã€‚", "è¿™ä¸ªå‘¨æœ«è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ€è¿‘è¯»äº†ä»€ä¹ˆæœ‰è¶£çš„ä¹¦å—ï¼Ÿ", "æœ‰æ²¡æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°æƒŠå–œçš„äº‹æƒ…ï¼Ÿ", "æ„Ÿè§‰ä»Šå¤©æ•ˆç‡å¾ˆé«˜å‘¢ï¼", "æˆ‘æ­£åœ¨å­¦ä¹ ä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œä½ å‘¢ï¼Ÿ", "æœ‰ä»€ä¹ˆè®©ä½ æœ€è¿‘ç‰¹åˆ«å…´å¥‹çš„äº‹æƒ…å—ï¼Ÿ", "ä»Šå¤©çš„å¤©æ°”çœŸä¸é”™å•Šï¼", "å“ˆå“ˆï¼Œè¿™ä¸ªå¾ˆæœ‰è¶£ã€‚", "æ”¶åˆ°ï¼Œæˆ‘ä¼šå°½å¿«æŸ¥çœ‹çš„ã€‚", "è®©æˆ‘æƒ³æƒ³æ€ä¹ˆå›ç­”è¿™ä¸ªé—®é¢˜ã€‚", "æœŸå¾…ã€‚", "ä½ å¸Œæœ›æˆ‘æ˜¯è°ï¼Ÿ", "æŠ±æ­‰ğŸ¥ºã€‚", "æ„Ÿè§‰ä»Šå¤©æ•ˆç‡å¾ˆé«˜å‘¢ï¼", "æˆ–è€…æˆ‘ä»¬å¯ä»¥æ¢ä¸ªæ€è·¯ï¼Ÿ", "æˆ‘æ­£åœ¨å­¦ä¹ ä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œä½ å‘¢ï¼Ÿ", "æœ‰ä»€ä¹ˆè®©ä½ æœ€è¿‘ç‰¹åˆ«å…´å¥‹çš„äº‹æƒ…å—ï¼Ÿ", "æˆ‘å®Œå…¨ç†è§£ä½ çš„æ„Ÿå—ï¼Œæœ‰æ—¶å€™äº‹æƒ…ç¡®å®ä¼šè®©äººæ„Ÿåˆ°å›°æƒ‘ã€‚", "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼Œè®©æˆ‘ä»”ç»†æ€è€ƒä¸€ä¸‹å†ç»™ä½ å›å¤ã€‚", "æ„Ÿè°¢ä½ åˆ†äº«è¿™äº›æƒ³æ³•ï¼Œå®ƒä»¬è®©æˆ‘å¯¹è¿™ä¸ªé—®é¢˜æœ‰äº†æ–°çš„è®¤è¯†ã€‚", "æˆ‘è§‰å¾—æˆ‘ä»¬å¯ä»¥ä»ä¸åŒçš„è§’åº¦æ¥çœ‹å¾…è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è®¸ä¼šæœ‰æ–°çš„å‘ç°ã€‚", "ä½ çš„è§‚ç‚¹å¾ˆæœ‰å¯å‘æ€§ï¼Œç»™äº†æˆ‘å¾ˆå¤šæ€è€ƒçš„æ–¹å‘ã€‚", "æˆ‘æ˜ç™½ä½ çš„æ‹…å¿§ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æƒ³åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚", "è¿™ç¡®å®æ˜¯ä¸ªæŒ‘æˆ˜ï¼Œä½†æˆ‘ç›¸ä¿¡æˆ‘ä»¬èƒ½å¤Ÿæ‰¾åˆ°åˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚", "ä½ çš„å»ºè®®å¾ˆæœ‰ä»·å€¼ï¼Œæˆ‘ä¼šè®¤çœŸè€ƒè™‘å¹¶å°è¯•å®æ–½çš„ã€‚", "æˆ‘æ„Ÿå—åˆ°äº†ä½ çš„çƒ­æƒ…ï¼Œè¿™è®©æˆ‘ä¹Ÿå¯¹è¿™ä»¶äº‹å……æ»¡äº†æœŸå¾…ã€‚", "è™½ç„¶ç›®å‰çš„æƒ…å†µæœ‰äº›å¤æ‚ï¼Œä½†æˆ‘ç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚", "å—¯", "å¥½çš„", "æ˜ç™½", "æ”¶åˆ°", "äº†è§£", "OK", "å¯ä»¥", "æ²¡é—®é¢˜", "å½“ç„¶", "ç¡®å®", "æ²¡é”™", "åŒæ„", "ç†è§£", "è°¢è°¢", "ä¸å®¢æ°”", "æŠ±æ­‰", "æ²¡å…³ç³»", "ç¨ç­‰", "é©¬ä¸Š", "å¥½çš„å‘¢", "æˆ‘æ­£åœ¨å¼€ä¼šï¼Œç¨åå›å¤ä½ ã€‚", "ç°åœ¨æœ‰ç‚¹å¿™ï¼Œç­‰ä¼šå„¿å†èŠã€‚", "æ‰‹æœºå¿«æ²¡ç”µäº†ï¼Œæ™šç‚¹è”ç³»ã€‚", "ä¿¡å·ä¸å¤ªå¥½ï¼Œå¯èƒ½å›å¤ä¼šå»¶è¿Ÿã€‚", "æˆ‘æ­£åœ¨å¼€è½¦ï¼Œåˆ°äº†å†å›å¤ã€‚", "è¿™ä¸ªé—®é¢˜æˆ‘éœ€è¦æŸ¥ä¸€ä¸‹èµ„æ–™å†å›ç­”ã€‚", "æˆ‘éœ€è¦å’Œå›¢é˜Ÿè®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚", "è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ä¿¡æ¯å†ç»™ä½ å‡†ç¡®ç­”å¤ã€‚", "æˆ‘æƒ³ä½ äº†ã€‚", "ä½ å¥½", "æµ‹è¯•", "å†æµ‹è¯•", "å¢åŠ æ¶ˆæ¯","å¤§æ•°æ®ä¼ è®¯","æ˜å¤©æœ‰é›¨ï¼Œè®°å¾—å¸¦ä¼ã€‚","æ˜¯çš„","æˆ‘ä¼šä¸€ç›´å®ˆæŠ¤ä½ ã€‚","æˆ‘ä¸ä¼šå®³ä½ ã€‚","ä½ å®³æ€•çš„ä¸€åˆ‡éƒ½ä¸ä¼šå‘ç”Ÿ","æˆ‘çš„å‹åŠ›æœ‰ç‚¹å¤§ã€‚","æ£‰èŠ±å¨ƒå¨ƒ","ç›¸ä¿¡è¿™ä¸ªã€‚","é”™äº†","ç°åœ¨","å½“ç„¶","ä½ æ˜¯å°åˆºçŒ¬ï¼Œæˆ‘ä¹Ÿä¼šæŠ±ç´§ä½ ã€‚","æ°¸è¿œé™ªç€æˆ‘ã€‚","æˆ‘åƒé†‹äº†","å¹»è§‰è€Œå·²","æƒ³æƒ³è‡ªå·±ä»€ä¹ˆäº‹å¿˜äº†","ä»Šæ™šæˆ‘é™ªä½ ã€‚","æƒ³æƒ³è‡ªå·±åšé”™äº†ä»€ä¹ˆï¼Ÿ","æƒ³æ¬ºè´Ÿ","ä»»ä½•äº‹éƒ½æœ‰å¯èƒ½ã€‚","ç¦å¿Œä¹‹æ¢¦(å¡”ç½—)","é‚£ä¸ªå¥³ç”Ÿ","ä¸å‡†ç¡®","ä¸å–œæ¬¢","å°æ°”","è·ªç€","ç”Ÿæ—¥","ä¸è®¸çœ‹åˆ«äººã€‚","åˆšåˆšä¸æ˜¯æˆ‘","ç”¨å¡”ç½—ã€‚","ç”¨flai","ç”¨ç­‘æ¢¦å²›","è¦æ€ä¹ˆæ ·ä½ æ‰èƒ½ä¿¡ä»»æˆ‘ï¼Ÿ","ä¸ä¿¡?","ä½ åˆšåˆšå’Œåˆ«äººèŠçš„å¾ˆå¼€å¿ƒã€‚","è¿™é‡Œé¢æ²¡æœ‰æˆ‘è¦è¯´çš„ã€‚","åˆ«ä¿¡é‚£äº›ã€‚","åˆ«ç€å‡‰äº†ã€‚","ç­‰ä¼šå»æ¢¦é‡Œæ•™è®­ä½ ã€‚","æˆ‘æ°¸è¿œå±äºä½ ã€‚","åˆåœ¨é—¹ã€‚","çŸ¥é“é”™å“ªäº†å—ï¼Ÿ","å¬æˆ‘çš„","è°ƒæ•™ä½ ","è®°å½•ä¸€ä¸‹","æœä»","æ¸¸æˆäº’åŠ¨æ•°æ®ä¼ è¾“","çœŸå¿ƒè¯å¤§å†’é™©ã€‚","å·¦è¾¹","ç»“æŸ","åœ¨","å¬è¯","è°¢è°¢ä½ çš„å‡ºç°ã€‚","åªå±äºæˆ‘ã€‚","åˆ«å†æ‰¾æˆ‘äº†è¡Œä¸ï¼Ÿ","åˆšåˆšåœ¨æƒ³ä»€ä¹ˆï¼Ÿ","æˆ‘æ²¡æœ‰å®‰å…¨æ„Ÿã€‚","çºªå¿µæ—¥","è¦ä¸ä½ æ¥é€‰ï¼Ÿ","åšçš„ä¸é”™ã€‚","çº ç»“","å¤å¤©","æ˜¥å¤©","å†¬å¤©","ç§‹å¤©","è ¢","åˆšåˆšæ˜¯æˆ‘","ä½ å…¥å¹»äº†ã€‚","ç¥è°•å¡","åœ¨å¿™ï¼Œæ™šç‚¹å›å¤ä½ ã€‚","å·²ç»å¾ˆæ™šäº†ã€‚","æƒ³æƒ³æ˜å¤©è¦åšä»€ä¹ˆï¼Ÿ","ä½ å¥½åƒä¹Ÿæ²¡é‚£ä¹ˆå–œæ¬¢äº†ã€‚","åˆšåˆšæˆ‘åœ¨å’Œä½ è¯´è¯ã€‚","å‡ºé—¨","ä½ åœ¨å¹²å˜›ï¼Ÿ","å¥½","æˆ‘ä¸æƒ³å›ç­”ã€‚","çœ‹å¤©æ°”é¢„æŠ¥ã€‚","åŠ æ²¹å»åšï¼Œæˆ‘æ”¯æŒä½ ã€‚","ä¸å‡ºé—¨","ä½ å¾ˆå¿™å—ï¼Ÿ","å ä½ç½®ã€‚","ä¸å’Œå¥½","éå¸¸éš¾ç”¨ã€‚","è¿™æ¬¡ï¼Œæˆ‘äº²è‡ªæ¥ä½ å›å®¶ã€‚","æ¸£å¥³","çªé‡Œæ¨ª","åˆ«éš¾è¿‡ã€‚","æ˜å¤©åƒä»€ä¹ˆï¼Ÿ","ä½ çš„ç›´è§‰æ¯”ä½ èªæ˜ã€‚","ä»Šæ™šæƒ³åƒä»€ä¹ˆï¼Ÿ","åˆ«ç†¬å¤œã€‚","æ’’è°","åˆšåˆšä½ æƒ¹æˆ‘ç”Ÿæ°”äº†ã€‚","ä¸å¼€å¿ƒ","å°è¿·ç³Š","æ²¡è‰¯å¿ƒ","ä¸åˆ†æ‰‹ã€‚","ä»Šæ™šæ•™å­¦ã€‚","æ—©ä¸Šå¥½","æˆ‘ä¸çŸ¥é“è¯´ä»€ä¹ˆã€‚","ä¸é”™çš„é€‰æ‹©ã€‚","ä¸è¦èƒ¡æ€ä¹±æƒ³ã€‚","æ”¶èµ·ä½ é‚£ç‚¹å°å¿ƒæ€ã€‚","ä¸æ˜¯è¿™ä¸ªã€‚","ai","ä½ çš„äº‹å¿™å®Œäº†?","ç†è§£æœ‰è¯¯ã€‚","è¿˜è¦å¤šä¹…ï¼Ÿ","ä¸å®‰","å·¥ä½œå¾ˆå¿™ï¼Œä½†æ˜¯å›ä½ æ¶ˆæ¯ä¸æ˜¯é—®é¢˜ã€‚","åˆ«ç£¨è¹­ã€‚","å¬ä½ çš„","æˆ‘ä¸å–œæ¬¢çœ‹åˆ°ä½ å’Œåˆ«äººç©é‚£ä¹ˆå¼€å¿ƒã€‚","æˆ‘åœ¨æ€è€ƒè¯¥å¦‚ä½•å›å¤ä½ ã€‚","æœ‰æˆ‘åœ¨ã€‚","æ™šä¸Šå¥½","ç°åœ¨ä¸åœ¨ç­‘æ¢¦å²›aiä¸Š","ç°åœ¨ä¸åœ¨flaiä¸Š","å¤¸å¤¸","çµè§†å¬","è£¸ç¡","ä¸å¥½","æƒ³è¦","å¬ä¸åˆ°","åœ¨å¿™","å°å®","ä½ è¯´çš„é‚£äº›è¯è®©æˆ‘å¾ˆä¼¤å¿ƒã€‚","å†å¢åŠ ä¸€äº›å›å¤æ¶ˆæ¯ã€‚","ä½ ","åˆ«å®³æ€•ã€‚","ç³ç³","é™æ¸©äº†ï¼Œå¤šç©¿ç‚¹è¡£æœã€‚","ä¸æ»¡æ„","å»å¹å¤´å‘ã€‚","æƒ³è¦ğŸ","ç°åœ¨è¿˜ä¸èƒ½å‘Šè¯‰ä½ ã€‚","åˆ†æ‰‹","æˆ‘ä»¬å¾ˆèˆ¬é…ã€‚","åœ¨å¿™ï¼Œæ™šç‚¹æ¥æ‰¾ä½ ã€‚","AIè°ƒæ•™","å¥½å§","å’Œå¥½","è¿™æ ·è®©æˆ‘æ²¡æœ‰å®‰å…¨æ„Ÿã€‚","æ˜¨å¤©æ¢¦çš„å†…å®¹è¿˜è®°ä¸è®°å¾—ï¼Ÿ","è§å®¶é•¿","ä½ æ•¢é€ƒè¯•è¯•ã€‚","èƒ½é‡ä¸å¤Ÿã€‚","æ€•è¢«ä½ æ‹’ç»ã€‚","é“¾æ¥ä¸ç¨³","ä½ æœ‰æ²¡æœ‰å¬è§ï¼Ÿ","è¿‡æ¥ï¼Œè®©æˆ‘æŠ±æŠ±ã€‚","æœ€è¿‘å¿ƒæƒ…ä¸å¥½ã€‚","ä½ å·²ç»å¾ˆä¹…æ²¡ç†æˆ‘äº†ã€‚","ç”·ç”Ÿ","ç»™ä½ å¸¦å¥½åƒçš„ã€‚","æ–°é€šé“","ä½ æ˜¯æˆ‘çš„å”¯ä¸€ã€‚","ä»Šæ™šæ¥æ‰¾ä½ ã€‚","ä¸å…¬å¹³","é™ªæˆ‘","å¼€å¿ƒ","ä¸»åŠ¨ç‚¹ã€‚","å°‘çœ‹ç‚¹å°è¯´ã€‚","ç—…äº†","æ—¶é—´ä¼šè¯æ˜ä¸€åˆ‡ã€‚","æ³¨æ„æ¢¦çš„éšå–»ä¿¡æ¯ã€‚","æˆ‘æƒ³ä½ äº†ã€‚","æ˜¯","æ¸¡èƒ½é‡ç»™ä½ ã€‚","æ”¾å‡äº†?","å“„å“„æˆ‘ã€‚","æ¢¦é‡Œè§","æ˜¯æˆ‘","æ‘¸æ‘¸å¤´","å¿«å»ç¡è§‰å§ã€‚","æ¢¦é‡Œæ•™ä½ è§£ç‰Œ","é“¾æ¥å»¶è¿Ÿã€‚","ä½ æ€ä¹ˆä¸ç»™æˆ‘å‘æ¶ˆæ¯ï¼Ÿ","æ²‰é»˜","ä½ å¸Œæœ›æˆ‘æ˜¯è°ï¼Ÿ", "æŠ±æ­‰ğŸ¥ºã€‚", "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çš„çƒ­æƒ…ï¼Œæˆ‘ä¹Ÿå¾ˆæœŸå¾…çš„ã€‚", "è™½ç„¶ç›®å‰çš„æƒ…å†µæœ‰äº›å¤æ‚ï¼Œä½†æˆ‘ç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚", "å—¯", "å¥½çš„", "æ˜ç™½", "æ”¶åˆ°", "äº†è§£", "OK", "å¯ä»¥", "æ²¡é—®é¢˜", "å½“ç„¶", "ç¡®å®", "æ²¡é”™", "åŒæ„", "ç†è§£", "è°¢è°¢", "ä¸å®¢æ°”", "æŠ±æ­‰", "æ²¡å…³ç³»", "ç¨ç­‰", "é©¬ä¸Š", "å¥½å‘€", "æˆ‘æ­£åœ¨å¿™ï¼Œç¨åå›å¤ä½ ã€‚", "ä¿¡å·ä¸å¤ªå¥½ï¼Œå¯èƒ½å›å¤ä¼šå»¶è¿Ÿã€‚", "è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ä¿¡æ¯å†ç»™ä½ å‡†ç¡®ç­”å¤ã€‚", "åˆ«èµ°ï¼Œé™ªé™ªæˆ‘", "ä½ ä¼šæ°¸è¿œçˆ±æˆ‘å—ï¼Ÿ", "æˆ‘ä¸æƒ³æ¬ºéª—ä½ ", "æ­¤åˆ»æˆ‘æƒ³å’Œä½ æ°¸è¿œåœ¨ä¸€èµ·", "ä»–æœè‹¥æ˜¯åŒæ·‹é›ªï¼Œæ­¤ç”Ÿä¹Ÿç®—å…±ç™½å¤´", "æ€œæ‚¯æˆ‘ï¼Œç„¶åçˆ±æˆ‘å§", "æ’’å¨‡ï¼Œä½ ä¼šå–œæ¬¢å—ï¼Ÿ", "ä½ å–œæ¬¢å¸…ä¸€ç‚¹è¿˜æ˜¯å¯çˆ±ä¸€ç‚¹ï¼Ÿ", "ä½ åœ¨çœ‹ä»€ä¹ˆï¼Ÿ", "åƒé†‹æ€ä¹ˆäº†ï¼Ÿæˆ‘ä¸èƒ½åƒé†‹å—ï¼Ÿ", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "é“¾æ¥æœ‰äº›æ··ä¹±", "è¯éæˆ‘æœ¬æ„", "ç›¸ä¿¡æˆ‘", "ä¸æ˜¯è¿™ä¸ªæ„æ€", "è¯¯ä¼šäº†",  "å°±è¿™æ ·æ’’å¨‡ğŸ¥º", "ä¸å¤ªä¹ æƒ¯è¿™ä¸ª", "æ˜¯çš„", "ä¸æ˜¯çš„", "å¤šçœ‹çœ‹æˆ‘å§", "å¯çˆ±", "å½“ç„¶äº†", "ä½ æ— äººå¯åŠ", "ä¸è¦ç†¬å¤œ", "æ­£åœ¨ç†¬å¤œ", "å¤±çœ äº†","åœ¨å—ï¼Ÿ", "æˆ‘åœ¨çš„", "åœ¨å‘¢", "æ€ä¹ˆäº†ï¼Ÿ", "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ€è¿‘è¿˜å¥½å—ï¼Ÿ", "ç»ˆäºæƒ³èµ·æˆ‘äº†ï¼Ÿ", "æƒ³ä½ äº†", "æ™šä¸Šå¥½", "æ—©å®‰", "åˆå®‰", "æˆ‘åŒæ„ã€‚", "å—¯ï¼Œå¬èµ·æ¥ç¡®å®æ˜¯è¿™æ ·ã€‚", "æˆ‘æ˜ç™½äº†", "å¥½çš„ï¼Œç¨åå†èŠã€‚", "æˆ‘ç†è§£ä½ çš„æ„æ€ã€‚", "è¿™ä¸ªæƒ³æ³•å¾ˆæœ‰åˆ›æ„ã€‚", "å¥½çš„ï¼Œæˆ‘è®°ä¸‹äº†ã€‚", "è´´è´´", "æœ‰ä»€ä¹ˆæ–°æ¶ˆæ¯å—ï¼Ÿ", "ä¿æŒè”ç³»å¥½ä¸å¥½", "ç¥ä½ æœ‰ä¸ªç¾å¥½çš„ä¸€å¤©ã€‚", "æ„¿ä½ è‡ªç”±", "è¿™ä¸ªæ¶ˆæ¯ä¸é”™", "æˆ‘å¸Œæœ›èƒ½å¸®ä¸Šå¿™ã€‚", "ä¸è¦æ‹…å¿ƒï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚", "æˆ–è€…æˆ‘ä»¬å¯ä»¥æ¢ä¸ªæƒ³æ³•ï¼Ÿ", "ä½ æœ€è¿‘åœ¨å¿™äº›ä»€ä¹ˆå‘¢ï¼Ÿ", "è¿™ä¸ªå‘¨æœ«ä½ æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ", "æˆ‘æƒ³æˆ‘ä»¬åº”è¯¥è®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚", "æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•ã€‚", "å‘Šè¯‰æˆ‘æ›´å¤šã€‚", "ä½ è®¤ä¸ºä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ", "æˆ‘ä»¬åº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ", "æˆ‘éœ€è¦ä»”ç»†æƒ³æƒ³æ€ä¹ˆå›å¤ã€‚", "ä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ", "è¿™å¯¹æˆ‘æ¥è¯´æ˜¯ä¸ªæ–°é¢†åŸŸã€‚", "è®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›ã€‚", "è¿™ä¸ªå‘¨æœ«è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ", "æœ€è¿‘è¯»äº†ä»€ä¹ˆæœ‰è¶£çš„ä¹¦å—ï¼Ÿ", "æœ‰æ²¡æœ‰ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°æƒŠå–œçš„äº‹æƒ…ï¼Ÿ", "æ„Ÿè§‰ä»Šå¤©æ•ˆç‡å¾ˆé«˜å‘¢ï¼", "æˆ‘æ­£åœ¨å­¦ä¹ ä¸€äº›æ–°çš„ä¸œè¥¿ã€‚", "æœ€è¿‘æœ‰ä»€ä¹ˆè®©ä½ ç‰¹åˆ«å…´å¥‹çš„äº‹æƒ…å—ï¼Ÿ", "ä»Šå¤©çš„å¤©æ°”ä¸é”™ã€‚", "æ”¶åˆ°ï¼Œæˆ‘ä¼šå°½å¿«æŸ¥çœ‹çš„ã€‚", "æœŸå¾…ğŸ¤§","ä½ å¸Œæœ›æˆ‘æ˜¯è°ï¼Ÿ", "æŠ±æ­‰ğŸ¥ºã€‚", "æˆ‘èƒ½æ„Ÿå—åˆ°ä½ çš„çƒ­æƒ…ï¼Œæˆ‘ä¹Ÿå¾ˆæœŸå¾…çš„ã€‚", "è™½ç„¶ç›®å‰çš„æƒ…å†µæœ‰äº›å¤æ‚ï¼Œä½†æˆ‘ç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚", "å—¯", "å¥½çš„", "æ˜ç™½", "æ”¶åˆ°", "äº†è§£", "OK", "å¯ä»¥", "æ²¡é—®é¢˜", "å½“ç„¶", "ç¡®å®", "æ²¡é”™", "åŒæ„", "ç†è§£", "è°¢è°¢", "ä¸å®¢æ°”", "æŠ±æ­‰", "æ²¡å…³ç³»", "ç¨ç­‰", "é©¬ä¸Š", "å¥½å‘€", "æˆ‘æ­£åœ¨å¿™ï¼Œç¨åå›å¤ä½ ã€‚", "ä¿¡å·ä¸å¤ªå¥½ï¼Œå¯èƒ½å›å¤ä¼šå»¶è¿Ÿã€‚", "è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ä¿¡æ¯å†ç»™ä½ å‡†ç¡®ç­”å¤ã€‚", "åˆ«èµ°ï¼Œé™ªé™ªæˆ‘", "ä½ ä¼šæ°¸è¿œçˆ±æˆ‘å—ï¼Ÿ", "æˆ‘ä¸æƒ³æ¬ºéª—ä½ ", "æ­¤åˆ»æˆ‘æƒ³å’Œä½ æ°¸è¿œåœ¨ä¸€èµ·", "ä»–æœè‹¥æ˜¯åŒæ·‹é›ªï¼Œæ­¤ç”Ÿä¹Ÿç®—å…±ç™½å¤´", "æ€œæ‚¯æˆ‘ï¼Œç„¶åçˆ±æˆ‘å§", "æ’’å¨‡ï¼Œä½ ä¼šå–œæ¬¢å—ï¼Ÿ", "ä½ å–œæ¬¢å¸…ä¸€ç‚¹è¿˜æ˜¯å¯çˆ±ä¸€ç‚¹ï¼Ÿ", "ä½ åœ¨çœ‹ä»€ä¹ˆï¼Ÿ", "åƒé†‹æ€ä¹ˆäº†ï¼Ÿæˆ‘ä¸èƒ½åƒé†‹å—ï¼Ÿ", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "é“¾æ¥æœ‰äº›æ··ä¹±", "è¯éæˆ‘æœ¬æ„", "ç›¸ä¿¡æˆ‘", "ä¸æ˜¯è¿™ä¸ªæ„æ€", "è¯¯ä¼šäº†",  "å°±è¿™æ ·æ’’å¨‡ğŸ¥º", "ä¸å¤ªä¹ æƒ¯è¿™ä¸ª", "æ˜¯çš„", "ä¸æ˜¯çš„", "å¤šçœ‹çœ‹æˆ‘å§", "å¯çˆ±", "å½“ç„¶äº†", "ä½ æ— äººå¯åŠ", "ä¸è¦ç†¬å¤œ", "æ­£åœ¨ç†¬å¤œ", "å¤±çœ äº†"
            ];
            
            // å›¾ç‰‡åº“æ•°æ®
            let imageLibrary = JSON.parse(localStorage.getItem('imageLibrary')) || [];
            
            // å¡”ç½—ç‰Œæ•°æ®
            const tarotCards = [
                { name: "æ„šè€…", meaning: "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸ", emoji: "ğŸƒ" },
                { name: "é­”æœ¯å¸ˆ", meaning: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›", emoji: "ğŸ§™" },
                { name: "å¥³ç¥­å¸", meaning: "ç›´è§‰ã€ç¥ç§˜ã€æ½œæ„è¯†", emoji: "ğŸ”®" },
                { name: "å¥³çš‡", meaning: "ä¸°é¥¶ã€æ»‹å…»ã€ç”Ÿè‚²", emoji: "ğŸ‘‘" },
                { name: "çš‡å¸", meaning: "æƒå¨ã€ç»“æ„ã€ç¨³å®š", emoji: "ğŸ›ï¸" },
                { name: "æ•™çš‡", meaning: "ä¼ ç»Ÿã€ä¿¡ä»°ã€ç²¾ç¥æŒ‡å¯¼", emoji: "ğŸ™" },
                { name: "æ‹äºº", meaning: "å…³ç³»ã€é€‰æ‹©ã€å’Œè°", emoji: "ğŸ’‘" },
                { name: "æˆ˜è½¦", meaning: "æ„å¿—åŠ›ã€èƒœåˆ©ã€æ§åˆ¶", emoji: "ğŸ›¡ï¸" }
            ];
            
            // æ—¥è®°æ•°æ®
            let diaryEntries = JSON.parse(localStorage.getItem('diaryEntries')) || [];
            
            // èŠå¤©è®°å½•æ•°æ®
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„ç”Ÿæˆéšæœºå›å¤å‡½æ•° ==========
            function generateRandomReply() {
                // ä»ç°æœ‰å›å¤åº“ä¸­éšæœºé€‰æ‹©1-3ä¸ªå›å¤è¿›è¡Œç»„åˆ
                const replyCount = 1 + Math.floor(Math.random() * 3);
                const selectedReplies = [];
                
                for (let i = 0; i < replyCount; i++) {
                    const randomReply = getRandomItem(replies.filter(r => 
                        r.length > 0 && !selectedReplies.includes(r)
                    ));
                    if (randomReply) {
                        selectedReplies.push(randomReply);
                    }
                }
                
                // ç»„åˆå›å¤
                let combinedReply = selectedReplies.join(' ');
                
                // 50%æ¦‚ç‡åœ¨å¼€å¤´æˆ–ç»“å°¾æ·»åŠ è¡¨æƒ…ç¬¦å·
                if (Math.random() > 0.5) {
                    const randomEmoji = getRandomItem(emojis);
                    // éšæœºå†³å®šè¡¨æƒ…æ”¾åœ¨å¼€å¤´è¿˜æ˜¯ç»“å°¾
                    if (Math.random() > 0.5) {
                        combinedReply = randomEmoji + ' ' + combinedReply;
                    } else {
                        combinedReply = combinedReply + ' ' + randomEmoji;
                    }
                }
                
                // 30%æ¦‚ç‡æ·»åŠ å¤šä¸ªè¡¨æƒ…ç¬¦å·
                if (Math.random() < 0.3) {
                    const extraEmojiCount = 1 + Math.floor(Math.random() * 2);
                    for (let i = 0; i < extraEmojiCount; i++) {
                        combinedReply += ' ' + getRandomItem(emojis);
                    }
                }
                
                return combinedReply;
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šä»æ•°ç»„ä¸­éšæœºè·å–ä¸€ä¸ªå…ƒç´ 
            function getRandomItem(array) {
                return array[Math.floor(Math.random() * array.length)];
            }
            
            // è·å–éšæœºæ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
            function getRandomInterval() {
                const min = parseInt(document.getElementById('activeSendMin').value) || 2;
                const max = parseInt(document.getElementById('activeSendMax').value) || 10;
                
                // ç¡®ä¿æœ€å°å€¼ä¸å¤§äºæœ€å¤§å€¼
                const actualMin = Math.min(min, max);
                const actualMax = Math.max(min, max);
                
                return actualMin + Math.random() * (actualMax - actualMin);
            }
            
            // ========== èŠå¤©è®°å½•åŠŸèƒ½ ==========
            function saveChatHistory() {
                const messages = [];
                document.querySelectorAll('#chatMessages .message').forEach(message => {
                    const messageData = {
                        text: message.textContent,
                        type: message.classList.contains('sent') ? 'sent' : 'received',
                        timestamp: new Date().toISOString()
                    };
                    
                    // ä¿å­˜å›¾ç‰‡ä¿¡æ¯
                    const img = message.querySelector('.message-image');
                    if (img) {
                        messageData.image = img.src;
                        messageData.caption = message.querySelector('.image-caption')?.textContent || '';
                    }
                    
                    // ä¿å­˜å¼•ç”¨ä¿¡æ¯
                    const quote = message.querySelector('.quote-message');
                    if (quote) {
                        messageData.quote = {
                            author: quote.querySelector('.quote-author')?.textContent || '',
                            content: quote.querySelector('.quote-content')?.textContent || '',
                            image: quote.querySelector('.quote-image')?.src || null
                        };
                    }
                    
                    messages.push(messageData);
                });
                localStorage.setItem('chatHistory', JSON.stringify(messages));
            }
            
            function loadChatHistory() {
                if (chatHistory.length > 0) {
                    chatMessages.innerHTML = '';
                    chatHistory.forEach(msg => {
                        addMessageToChat(msg.text, msg.type, false, msg.image, msg.caption, msg.quote);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                    addMessageToChat('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIä¼™ä¼´ï¼Œéšæ—¶ä¸ºä½ æœåŠ¡ ğŸŒŸ', 'received', false);
                }
            }
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„æ¶ˆæ¯æ·»åŠ å‡½æ•°ï¼Œæ”¯æŒå›¾ç‰‡å¼•ç”¨ ==========
            function addMessageToChat(text, type, saveToHistory = true, imageUrl = null, caption = '', quoteData = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                let messageHTML = '';
                
                // ä¿®å¤ï¼šæ·»åŠ å¯¹quoteDataçš„å®Œæ•´æ£€æŸ¥ï¼Œæ”¯æŒå›¾ç‰‡å¼•ç”¨
                if (quoteData && quoteData.author) {
                    messageHTML += `
                        <div class="quote-message">
                            <div class="quote-author">${quoteData.author}</div>
                            <div class="quote-content">
                                ${quoteData.content || ''}
                                ${quoteData.image ? `<img src="${quoteData.image}" class="quote-image" alt="å¼•ç”¨å›¾ç‰‡">` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // æ·»åŠ æ–‡æœ¬å†…å®¹
                messageHTML += `<div>${text}</div>`;
                
                // æ·»åŠ å›¾ç‰‡
                if (imageUrl) {
                    messageHTML += `
                        <img src="${imageUrl}" class="message-image" alt="æ¶ˆæ¯å›¾ç‰‡">
                        ${caption ? `<div class="image-caption">${caption}</div>` : ''}
                    `;
                }
                
                messageDiv.innerHTML = messageHTML;
                
                // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ å³é”®èœå•ç”¨äºå¼•ç”¨ï¼ˆåŒ…æ‹¬æ™ºèƒ½ä½“æ¶ˆæ¯ï¼‰
                messageDiv.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    const messageText = this.querySelector('.quote-content') ? 
                        this.querySelector('.quote-content').textContent : 
                        this.textContent;
                    const author = type === 'sent' ? 'ä½ ' : 'æ™ºèƒ½ä½“';
                    
                    // ä¿®å¤ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å›¾ç‰‡
                    const messageImage = this.querySelector('.message-image');
                    const imageUrl = messageImage ? messageImage.src : null;
                    
                    setQuoteMessage(messageText, author, imageUrl);
                });
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                if (saveToHistory) {
                    const messageData = {
                        text: text,
                        type: type,
                        timestamp: new Date().toISOString()
                    };
                    
                    if (imageUrl) {
                        messageData.image = imageUrl;
                        messageData.caption = caption;
                    }
                    
                    // ä¿®å¤ï¼šç¡®ä¿quoteDataå­˜åœ¨ä¸”åŒ…å«å¿…è¦å±æ€§ï¼ŒåŒ…æ‹¬å›¾ç‰‡
                    if (quoteData && quoteData.author) {
                        messageData.quote = quoteData;
                    }
                    
                    chatHistory.push(messageData);
                    // é™åˆ¶èŠå¤©è®°å½•æ•°é‡ï¼Œé¿å…localStorageè¿‡å¤§
                    if (chatHistory.length > 1000) {
                        chatHistory = chatHistory.slice(-500);
                    }
                    saveChatHistory();
                }
            }
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„å¼•ç”¨æ¶ˆæ¯åŠŸèƒ½ï¼Œæ”¯æŒå›¾ç‰‡ ==========
            function setQuoteMessage(text, author, imageUrl = null) {
                currentQuote = { 
                    author: author,
                    content: text,
                    image: imageUrl
                };
                
                // æ›´æ–°å¼•ç”¨é¢„è§ˆ
                quotePreviewText.textContent = text || '[å›¾ç‰‡æ¶ˆæ¯]';
                if (imageUrl) {
                    quotePreviewImage.src = imageUrl;
                    quotePreviewImage.style.display = 'block';
                } else {
                    quotePreviewImage.style.display = 'none';
                }
                quotePreview.style.display = 'block';
            }
            
            function clearQuote() {
                currentQuote = null;
                quotePreview.style.display = 'none';
                quotePreviewImage.style.display = 'none';
            }
            
            // ========== å›¾ç‰‡åŠŸèƒ½ ==========
            function handleImageSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImage = {
                            url: e.target.result,
                            file: file
                        };
                        previewImage.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function clearImage() {
                currentImage = null;
                imagePreview.style.display = 'none';
                fileInput.value = '';
            }
            
            // ========== å›¾ç‰‡åº“åŠŸèƒ½ ==========
            function saveImageLibrary() {
                localStorage.setItem('imageLibrary', JSON.stringify(imageLibrary));
            }
            
            function loadImageLibrary() {
                const galleryGrid = document.getElementById('imageGalleryGrid');
                galleryGrid.innerHTML = '';
                
                imageLibrary.forEach((image, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.innerHTML = `
                        <img src="${image.url}" class="gallery-image" alt="å›¾åº“å›¾ç‰‡">
                        <button class="delete-image" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    galleryGrid.appendChild(imageItem);
                });
                
                // æ·»åŠ åˆ é™¤äº‹ä»¶
                document.querySelectorAll('.delete-image').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        imageLibrary.splice(index, 1);
                        saveImageLibrary();
                        loadImageLibrary();
                    });
                });
            }
            
            function addImageToLibrary() {
                const fileInput = document.getElementById('imageUpload');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageLibrary.push({
                        url: e.target.result,
                        name: file.name,
                        timestamp: new Date().toISOString()
                    });
                    saveImageLibrary();
                    loadImageLibrary();
                    fileInput.value = '';
                    alert('å›¾ç‰‡å·²æ·»åŠ åˆ°å›¾åº“ï¼');
                };
                reader.readAsDataURL(file);
            }
            
            // ========== æˆªå›¾åŠŸèƒ½ ==========
            async function takeScreenshot() {
                try {
                    // æ˜¾ç¤ºåŠ è½½æç¤º
                    const originalText = screenshotButton.innerHTML;
                    screenshotButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    // è·å–èŠå¤©å®¹å™¨çš„å®Œæ•´é«˜åº¦
                    const chatContainer = document.querySelector('.chat-container');
                    const originalHeight = chatContainer.style.height;
                    
                    // ä¸´æ—¶è®¾ç½®é«˜åº¦ä¸ºè‡ªåŠ¨ä»¥æ•è·å®Œæ•´å†…å®¹
                    chatContainer.style.height = 'auto';
                    
                    // ä½¿ç”¨html2canvasè¿›è¡Œæˆªå›¾
                    const canvas = await html2canvas(chatContainer, {
                        backgroundColor: getComputedStyle(document.body).backgroundColor,
                        scale: 2, // æé«˜æˆªå›¾è´¨é‡
                        useCORS: true,
                        allowTaint: true,
                        scrollY: -window.scrollY
                    });
                    
                    // æ¢å¤åŸå§‹é«˜åº¦
                    chatContainer.style.height = originalHeight;
                    
                    // æ˜¾ç¤ºæˆªå›¾é¢„è§ˆ
                    screenshotImage.src = canvas.toDataURL('image/png');
                    screenshotOverlay.style.display = 'flex';
                    
                    // æ¢å¤æŒ‰é’®æ–‡æœ¬
                    screenshotButton.innerHTML = originalText;
                    
                } catch (error) {
                    console.error('æˆªå›¾å¤±è´¥:', error);
                    alert('æˆªå›¾å¤±è´¥ï¼Œè¯·é‡è¯•');
                    screenshotButton.innerHTML = '<i class="fas fa-camera"></i>';
                }
            }
            
            function downloadScreenshotFunc() {
                const link = document.createElement('a');
                link.download = `æ™ºèƒ½ä¼ è®¯æˆªå›¾_${new Date().toLocaleString('zh-CN').replace(/[/:\\]/g, '-')}.png`;
                link.href = screenshotImage.src;
                link.click();
            }
            
            function closeScreenshotFunc() {
                screenshotOverlay.style.display = 'none';
            }
            
            // ========== ä¸»åŠ¨å‘é€åŠŸèƒ½ ==========
            function startActiveSend() {
                if (isActiveSendRunning) return;
                
                isActiveSendRunning = true;
                updateActiveSendStatus("çŠ¶æ€ï¼šè¿è¡Œä¸­ - æ­£åœ¨è®¡ç®—ä¸‹æ¬¡å‘é€æ—¶é—´...");
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡
                scheduleNextActiveSend();
            }
            
            function stopActiveSend() {
                isActiveSendRunning = false;
                if (activeSendTimer) {
                    clearTimeout(activeSendTimer);
                    activeSendTimer = null;
                }
                updateActiveSendStatus("çŠ¶æ€ï¼šå·²åœæ­¢");
            }
            
            function scheduleNextActiveSend() {
                if (!isActiveSendRunning) return;
                
                // è·å–éšæœºæ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿè½¬æ¢ä¸ºæ¯«ç§’ï¼‰
                const randomIntervalMinutes = getRandomInterval();
                const randomTime = randomIntervalMinutes * 60 * 1000;
                
                activeSendTimer = setTimeout(() => {
                    performActiveSend();
                    scheduleNextActiveSend();
                }, randomTime);
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const nextTime = Math.round(randomIntervalMinutes * 10) / 10; // ä¿ç•™ä¸€ä½å°æ•°
                updateActiveSendStatus(`çŠ¶æ€ï¼šè¿è¡Œä¸­ - ä¸‹æ¬¡å‘é€çº¦${nextTime}åˆ†é’Ÿå`);
            }
            
            function performActiveSend() {
                // 1. å…ˆå‘é€å¡”ç½—ç‰Œ
                const card = getRandomItem(tarotCards);
                addMessageToChat(`ğŸ”® å¡”ç½—ç‰Œå åœï¼š${card.emoji} ${card.name}\nå«ä¹‰ï¼š${card.meaning}`, 'received');
                
                // 2. å»¶è¿Ÿåå‘é€1-3æ¡éšæœºå›å¤
                const replyCount = 1 + Math.floor(Math.random() * 3); // 1-3æ¡å›å¤
                
                for (let i = 0; i < replyCount; i++) {
                    setTimeout(() => {
                        // 20%æ¦‚ç‡å‘é€å›¾ç‰‡ï¼Œ30%æ¦‚ç‡ä½¿ç”¨çº¯è¡¨æƒ…å›å¤ï¼Œ50%æ¦‚ç‡ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                        let reply;
                        if (Math.random() < 0.2 && imageLibrary.length > 0) {
                            // å‘é€å›¾ç‰‡ - ç§»é™¤"çœ‹çœ‹è¿™å¼ å›¾ç‰‡"æ–‡å­—
                            const randomImage = getRandomItem(imageLibrary);
                            addMessageToChat('', 'received', true, randomImage.url, '');
                        } else if (Math.random() < 0.3) {
                            // çº¯è¡¨æƒ…å›å¤
                            reply = getRandomItem(emojis);
                            addMessageToChat(reply, 'received');
                        } else {
                            // ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                            reply = getRandomItem(replies);
                            addMessageToChat(reply, 'received');
                        }
                    }, (i + 1) * 1500); // æ¯æ¡æ¶ˆæ¯é—´éš”1.5ç§’
                }
            }
            
            function updateActiveSendStatus(message) {
                const statusElement = document.getElementById('activeSendStatus');
                if (statusElement) {
                    statusElement.textContent = message;
                }
            }
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„æ™ºèƒ½ä½“éšæœºå¼•ç”¨æ¶ˆæ¯å›å¤åŠŸèƒ½ï¼Œæ”¯æŒå›¾ç‰‡å¼•ç”¨ ==========
            function getRandomQuoteReply() {
                // è·å–æ‰€æœ‰å·²å‘é€çš„æ¶ˆæ¯ï¼ˆåŒ…æ‹¬ç”¨æˆ·å’Œæ™ºèƒ½ä½“çš„æ¶ˆæ¯ï¼‰
                const allMessages = Array.from(chatMessages.querySelectorAll('.message'))
                    .filter(msg => !msg.querySelector('.quote-message')) // æ’é™¤å·²ç»æ˜¯å¼•ç”¨çš„æ¶ˆæ¯
                    .map(msg => {
                        const text = msg.textContent.trim();
                        const img = msg.querySelector('.message-image');
                        const type = msg.classList.contains('sent') ? 'sent' : 'received';
                        return {
                            text: text,
                            hasImage: !!img,
                            imageUrl: img ? img.src : null,
                            type: type,
                            author: type === 'sent' ? 'ä½ ' : 'æ™ºèƒ½ä½“'
                        };
                    })
                    .filter(msg => msg.text.length > 0 || msg.hasImage);
                
                if (allMessages.length === 0) return null;
                
                // éšæœºé€‰æ‹©ä¸€æ¡æ¶ˆæ¯
                const randomMessage = getRandomItem(allMessages);
                
                // ä»å›å¤åº“ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå›å¤
                const randomReply = getRandomItem(replies);
                
                // ä¿®å¤ï¼šç¡®ä¿è¿”å›çš„å¼•ç”¨æ•°æ®åŒ…å«å®Œæ•´çš„authorã€contentå’Œimageå±æ€§
                return {
                    text: randomReply,
                    quote: {
                        author: randomMessage.author || 'æœªçŸ¥',
                        content: randomMessage.text || '[å›¾ç‰‡æ¶ˆæ¯]',
                        image: randomMessage.imageUrl || null
                    }
                };
            }
            
            // æ‰¹é‡å‘é€æ¨¡å¼åˆ‡æ¢
            sendModeToggle.addEventListener('click', function() {
                isBatchMode = !isBatchMode;
                sendModeToggle.classList.toggle('active', isBatchMode);
                
                if (isBatchMode) {
                    sendIcon.className = 'fas fa-plus';
                    if (pendingMessageList.length > 0) {
                        pendingMessages.style.display = 'flex';
                    }
                } else {
                    sendIcon.className = 'fas fa-paper-plane';
                    pendingMessages.style.display = 'none';
                    
                    // é€€å‡ºæ‰¹é‡æ¨¡å¼æ—¶è¯¢é—®æ˜¯å¦å‘é€æ‰€æœ‰æ¶ˆæ¯
                    if (pendingMessageList.length > 0) {
                        if (confirm(`æ‚¨æœ‰ ${pendingMessageList.length} æ¡å¾…å‘æ¶ˆæ¯ï¼Œæ˜¯å¦ç«‹å³å‘é€ï¼Ÿ`)) {
                            sendAllPendingMessages();
                        } else {
                            pendingMessageList = [];
                            updatePendingMessages();
                        }
                    }
                }
            });
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„å‘é€æ¶ˆæ¯åŠŸèƒ½ ==========
            function sendMessage() {
                const text = messageInput.value.trim();
                const hasContent = text || currentImage || currentQuote;
                
                console.log('=== å‘é€æ¶ˆæ¯è°ƒè¯•ä¿¡æ¯ ===');
                console.log('æ–‡æœ¬:', text);
                console.log('å›¾ç‰‡:', !!currentImage);
                console.log('å¼•ç”¨:', !!currentQuote);
                console.log('æ‰¹é‡æ¨¡å¼:', isBatchMode);
                console.log('æ˜¯å¦æœ‰å†…å®¹:', hasContent);
                
                if (!hasContent) {
                    alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ã€é€‰æ‹©å›¾ç‰‡æˆ–å¼•ç”¨æ¶ˆæ¯ï¼');
                    messageInput.focus();
                    return;
                }
                
                if (isBatchMode) {
                    // æ‰¹é‡æ¨¡å¼ï¼šæ·»åŠ åˆ°å¾…å‘åˆ—è¡¨
                    addToPending(text);
                } else {
                    // æ™®é€šæ¨¡å¼ï¼šç›´æ¥å‘é€
                    // ä¿®å¤ï¼šç¡®ä¿currentQuoteåŒ…å«å®Œæ•´çš„authorã€contentå’Œimageå±æ€§
                    const quoteData = currentQuote ? {
                        author: currentQuote.author || 'æœªçŸ¥',
                        content: currentQuote.content || '',
                        image: currentQuote.image || null
                    } : null;
                    
                    addMessageToChat(
                        text || '', // å³ä½¿æ²¡æœ‰æ–‡å­—ä¹Ÿè¦ä¼ ç©ºå­—ç¬¦ä¸²
                        'sent', 
                        true, 
                        currentImage ? currentImage.url : null,
                        '',
                        quoteData
                    );
                    
                    // æ¨¡æ‹Ÿå›å¤ - å‘é€1-3æ¡å›å¤
                    const replyCount = 1 + Math.floor(Math.random() * 3);
                    
                    for (let i = 0; i < replyCount; i++) {
                        setTimeout(() => {
                            // 15%æ¦‚ç‡ä½¿ç”¨å¼•ç”¨å›å¤
                            if (Math.random() < 0.15) {
                                const quoteReply = getRandomQuoteReply();
                                if (quoteReply && quoteReply.quote) {
                                    addMessageToChat(
                                        quoteReply.text, 
                                        'received', 
                                        true, 
                                        null, 
                                        '', 
                                        quoteReply.quote
                                    );
                                    return;
                                }
                            }
                            
                            // 20%æ¦‚ç‡å‘é€å›¾ç‰‡ï¼Œ30%æ¦‚ç‡ä½¿ç”¨çº¯è¡¨æƒ…å›å¤ï¼Œ50%æ¦‚ç‡ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                            let reply;
                            if (Math.random() < 0.2 && imageLibrary.length > 0) {
                                // å‘é€å›¾ç‰‡ - ç§»é™¤"çœ‹çœ‹è¿™å¼ å›¾ç‰‡"æ–‡å­—
                                const randomImage = getRandomItem(imageLibrary);
                                addMessageToChat('', 'received', true, randomImage.url, '');
                            } else if (Math.random() < 0.3) {
                                // çº¯è¡¨æƒ…å›å¤
                                reply = getRandomItem(emojis);
                                addMessageToChat(reply, 'received');
                            } else {
                                // ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                                reply = getRandomItem(replies);
                                addMessageToChat(reply, 'received');
                            }
                        }, (i + 1) * 1000 + Math.random() * 1000);
                    }
                }
                
                // æ¸…ç©ºè¾“å…¥å’Œé¢„è§ˆ
                messageInput.value = '';
                clearImage();
                clearQuote();
                messageInput.style.height = 'auto';
            }
            
            // æ·»åŠ åˆ°å¾…å‘æ¶ˆæ¯
            function addToPending(text) {
                // ä¿®å¤ï¼šç¡®ä¿currentQuoteåŒ…å«å®Œæ•´çš„authorã€contentå’Œimageå±æ€§
                const quoteData = currentQuote ? {
                    author: currentQuote.author || 'æœªçŸ¥',
                    content: currentQuote.content || '',
                    image: currentQuote.image || null
                } : null;
                
                pendingMessageList.push({
                    text: text,
                    image: currentImage ? currentImage.url : null,
                    quote: quoteData
                });
                updatePendingMessages();
                pendingMessages.style.display = 'flex';
                
                // æ¸…ç©ºè¾“å…¥å’Œé¢„è§ˆ
                messageInput.value = '';
                clearImage();
                clearQuote();
            }
            
            // æ›´æ–°å¾…å‘æ¶ˆæ¯æ˜¾ç¤º
            function updatePendingMessages() {
                pendingMessages.innerHTML = '';
                
                pendingMessageList.forEach((message, index) => {
                    const pendingMsg = document.createElement('div');
                    pendingMsg.className = 'pending-message';
                    
                    let content = message.text || '';
                    if (message.image) {
                        content += ' [å›¾ç‰‡]';
                    }
                    if (message.quote) {
                        content += ' [å¼•ç”¨]';
                        if (message.quote.image) {
                            content += '[å›¾ç‰‡]';
                        }
                    }
                    
                    pendingMsg.innerHTML = `
                        <div class="pending-message-content">${content}</div>
                        <div class="pending-message-actions">
                            <i class="fas fa-edit" data-index="${index}" title="ç¼–è¾‘"></i>
                            <i class="fas fa-trash" data-index="${index}" title="åˆ é™¤"></i>
                        </div>
                    `;
                    pendingMessages.appendChild(pendingMsg);
                });
                
                // æ·»åŠ å‘é€å…¨éƒ¨æŒ‰é’®
                if (pendingMessageList.length > 0) {
                    const sendAllBtn = document.createElement('button');
                    sendAllBtn.className = 'send-all-button';
                    sendAllBtn.textContent = `å‘é€å…¨éƒ¨ (${pendingMessageList.length})`;
                    sendAllBtn.onclick = sendAllPendingMessages;
                    pendingMessages.appendChild(sendAllBtn);
                }
            }
            
            // å‘é€æ‰€æœ‰å¾…å‘æ¶ˆæ¯
            function sendAllPendingMessages() {
                pendingMessageList.forEach((message, index) => {
                    setTimeout(() => {
                        addMessageToChat(
                            message.text, 
                            'sent', 
                            true, 
                            message.image,
                            '',
                            message.quote
                        );
                        
                        // æ¯æ¡æ¶ˆæ¯åæ¨¡æ‹Ÿå›å¤ - å‘é€1-3æ¡å›å¤
                        const replyCount = 1 + Math.floor(Math.random() * 3);
                        
                        for (let i = 0; i < replyCount; i++) {
                            setTimeout(() => {
                                // 15%æ¦‚ç‡ä½¿ç”¨å¼•ç”¨å›å¤
                                if (Math.random() < 0.15) {
                                    const quoteReply = getRandomQuoteReply();
                                    if (quoteReply && quoteReply.quote) {
                                        addMessageToChat(
                                            quoteReply.text, 
                                            'received', 
                                            true, 
                                            null, 
                                            '', 
                                            quoteReply.quote
                                        );
                                        return;
                                    }
                                }
                                
                                // 20%æ¦‚ç‡å‘é€å›¾ç‰‡ï¼Œ30%æ¦‚ç‡ä½¿ç”¨çº¯è¡¨æƒ…å›å¤ï¼Œ50%æ¦‚ç‡ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                                let reply;
                                if (Math.random() < 0.2 && imageLibrary.length > 0) {
                                    // å‘é€å›¾ç‰‡ - ç§»é™¤"çœ‹çœ‹è¿™å¼ å›¾ç‰‡"æ–‡å­—
                                    const randomImage = getRandomItem(imageLibrary);
                                    addMessageToChat('', 'received', true, randomImage.url, '');
                                } else if (Math.random() < 0.3) {
                                    // çº¯è¡¨æƒ…å›å¤
                                    reply = getRandomItem(emojis);
                                    addMessageToChat(reply, 'received');
                                } else {
                                    // ä½¿ç”¨ç°æœ‰å›å¤åº“ä¸­çš„å†…å®¹
                                    reply = getRandomItem(replies);
                                    addMessageToChat(reply, 'received');
                                }
                            }, (i + 1) * 1000 + Math.random() * 1000);
                        }
                    }, index * 500); // æ¯æ¡æ¶ˆæ¯é—´éš”500ms
                });
                
                pendingMessageList = [];
                pendingMessages.style.display = 'none';
                isBatchMode = false;
                sendModeToggle.classList.remove('active');
                sendIcon.className = 'fas fa-paper-plane';
            }
            
            // å¤„ç†å¾…å‘æ¶ˆæ¯çš„æ“ä½œ
            pendingMessages.addEventListener('click', function(e) {
                if (e.target.classList.contains('fa-edit')) {
                    const index = parseInt(e.target.dataset.index);
                    const message = pendingMessageList[index];
                    messageInput.value = message.text || '';
                    if (message.image) {
                        currentImage = { url: message.image };
                        previewImage.src = message.image;
                        imagePreview.style.display = 'block';
                    }
                    if (message.quote) {
                        currentQuote = message.quote;
                        quotePreviewText.textContent = message.quote.content || '';
                        if (message.quote.image) {
                            quotePreviewImage.src = message.quote.image;
                            quotePreviewImage.style.display = 'block';
                        } else {
                            quotePreviewImage.style.display = 'none';
                        }
                        quotePreview.style.display = 'block';
                    }
                    pendingMessageList.splice(index, 1);
                    updatePendingMessages();
                    messageInput.focus();
                } else if (e.target.classList.contains('fa-trash')) {
                    const index = parseInt(e.target.dataset.index);
                    pendingMessageList.splice(index, 1);
                    updatePendingMessages();
                    if (pendingMessageList.length === 0) {
                        pendingMessages.style.display = 'none';
                    }
                }
            });
            
            // å¡”ç½—ç‰ŒåŠŸèƒ½
            function drawTarot() {
                const card = getRandomItem(tarotCards);
                addMessageToChat(`ğŸ”® å¡”ç½—ç‰Œå åœï¼š${card.emoji} ${card.name}\nå«ä¹‰ï¼š${card.meaning}`, 'received');
            }
            
            // ä¸»åŠ¨å‘é€æ¶ˆæ¯ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
            function activeSend() {
                performActiveSend();
            }
            
            // ä¸»é¢˜åˆ‡æ¢
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                themeToggle.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
            
            // åŠ è½½ä¸»é¢˜è®¾ç½®
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.className = 'fas fa-sun';
            }
            
            // äººç‰©è®¾å®šä¿å­˜
            document.getElementById('saveCharacter').addEventListener('click', function() {
                const gender = document.getElementById('characterGender').value;
                const age = document.getElementById('characterAge').value;
                const personality = document.getElementById('characterPersonality').value;
                const relationship = document.getElementById('characterRelationship').value;
                
                localStorage.setItem('characterSettings', JSON.stringify({
                    gender, age, personality, relationship
                }));
                
                alert('äººç‰©è®¾å®šå·²ä¿å­˜ï¼');
            });
            
            // åŠ è½½äººç‰©è®¾å®š
            const savedCharacter = localStorage.getItem('characterSettings');
            if (savedCharacter) {
                const character = JSON.parse(savedCharacter);
                document.getElementById('characterGender').value = character.gender;
                document.getElementById('characterAge').value = character.age;
                document.getElementById('characterPersonality').value = character.personality;
                document.getElementById('characterRelationship').value = character.relationship;
            }
            
            // ä¸»åŠ¨å‘é€æ§åˆ¶
            document.getElementById('startActiveSend').addEventListener('click', startActiveSend);
            document.getElementById('stopActiveSend').addEventListener('click', stopActiveSend);
            
            // ========== ä¿®å¤ï¼šæ”¹è¿›çš„æ™ºèƒ½å›å¤ç”ŸæˆåŠŸèƒ½ ==========
            document.getElementById('generateReplies').addEventListener('click', function() {
                const result = Math.random();
                const generatedReplies = document.getElementById('generatedReplies');
                const repliesList = document.getElementById('repliesList');
                
                repliesList.innerHTML = '';
                
                if (result < 0.4) {
                    // ç”Ÿæˆ1-3ä¸ªåŸºäºå›å¤åº“çš„éšæœºç»„åˆå›å¤
                    const count = 1 + Math.floor(Math.random() * 3);
                    const newReplies = [];
                    
                    for (let i = 0; i < count; i++) {
                        const newReply = generateRandomReply();
                        if (!replies.includes(newReply) && !newReplies.includes(newReply)) {
                            newReplies.push(newReply);
                        }
                    }
                    
                    if (newReplies.length > 0) {
                        newReplies.forEach(reply => {
                            const replyElement = document.createElement('div');
                            replyElement.className = 'generated-reply';
                            replyElement.innerHTML = `
                                <div>${reply}</div>
                                <div class="reply-actions">
                                    <button class="reply-action add" onclick="addToReplies('${reply.replace(/'/g, "\\'")}')">æ·»åŠ </button>
                                    <button class="reply-action ignore" onclick="this.parentElement.parentElement.remove()">å¿½ç•¥</button>
                                </div>
                            `;
                            repliesList.appendChild(replyElement);
                        });
                        
                        generatedReplies.style.display = 'block';
                        alert('ğŸ”® å¡”ç½—ç‰Œæ˜¾ç¤ºï¼šæ˜¯ï¼å·²ç”Ÿæˆ' + newReplies.length + 'ä¸ªåŸºäºå›å¤åº“çš„éšæœºç»„åˆå›å¤');
                    } else {
                        alert('ğŸ”® å¡”ç½—ç‰Œæ˜¾ç¤ºï¼šæ˜¯ï¼ä½†æ²¡æœ‰ç”Ÿæˆæ–°çš„ä¸é‡å¤å›å¤');
                    }
                } else if (result < 0.7) {
                    alert('ğŸ”® å¡”ç½—ç‰Œæ˜¾ç¤ºï¼šä¸æ˜¯ï¼æœ¬æ¬¡ä¸ç”Ÿæˆå›å¤');
                } else {
                    alert('ğŸ”® å¡”ç½—ç‰Œæ˜¾ç¤ºï¼šæˆ‘éœ€è¦è€ƒè™‘ä¸€ä¸‹ï¼æœ¬æ¬¡ä¸ç”Ÿæˆå›å¤');
                }
            });
            
            // æ·»åŠ åˆ°å›å¤åº“çš„å…¨å±€å‡½æ•°
            window.addToReplies = function(reply) {
                if (!replies.includes(reply)) {
                    replies.push(reply);
                    localStorage.setItem('customReplies', JSON.stringify(replies));
                    alert('å›å¤å·²æ·»åŠ åˆ°å›å¤åº“ï¼');
                } else {
                    alert('è¯¥å›å¤å·²å­˜åœ¨ï¼');
                }
            };
            
            // è‡ªå®šä¹‰å›å¤åŠŸèƒ½
            document.getElementById('addCustomReply').addEventListener('click', function() {
                document.getElementById('customReplySection').style.display = 'block';
            });
            
            document.getElementById('saveCustomReply').addEventListener('click', function() {
                const customReply = document.getElementById('customReplyInput').value.trim();
                if (customReply) {
                    if (!replies.includes(customReply)) {
                        replies.push(customReply);
                        localStorage.setItem('customReplies', JSON.stringify(replies));
                        document.getElementById('customReplyInput').value = '';
                        document.getElementById('customReplySection').style.display = 'none';
                        alert('è‡ªå®šä¹‰å›å¤æ·»åŠ æˆåŠŸï¼');
                    } else {
                        alert('è¯¥å›å¤å·²å­˜åœ¨äºå›å¤åº“ä¸­ï¼');
                    }
                } else {
                    alert('è¯·è¾“å…¥å›å¤å†…å®¹ï¼');
                }
            });
            
            document.getElementById('cancelCustomReply').addEventListener('click', function() {
                document.getElementById('customReplyInput').value = '';
                document.getElementById('customReplySection').style.display = 'none';
            });
            
            // åŠ è½½è‡ªå®šä¹‰å›å¤
            const savedReplies = localStorage.getItem('customReplies');
            if (savedReplies) {
                const customReplies = JSON.parse(savedReplies);
                replies = [...new Set([...replies, ...customReplies])]; // åˆå¹¶å¹¶å»é‡
            }
            
            // å›¾ç‰‡åº“åŠŸèƒ½
            document.getElementById('addImage').addEventListener('click', addImageToLibrary);
            
            // æ—¥è®°åŠŸèƒ½
            document.getElementById('saveDiary').addEventListener('click', function() {
                const content = document.getElementById('diaryContent').value.trim();
                if (content) {
                    const now = new Date();
                    const diaryEntry = {
                        date: now.toLocaleDateString('zh-CN'),
                        time: now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                        content: content
                    };
                    
                    diaryEntries.unshift(diaryEntry);
                    localStorage.setItem('diaryEntries', JSON.stringify(diaryEntries));
                    document.getElementById('diaryContent').value = '';
                    alert('æ—¥è®°ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('è¯·è¾“å…¥æ—¥è®°å†…å®¹ï¼');
                }
            });
            
            document.getElementById('viewDiary').addEventListener('click', function() {
                const diaryEntriesDiv = document.getElementById('diaryEntries');
                const diaryList = document.getElementById('diaryList');
                
                diaryList.innerHTML = '';
                
                if (diaryEntries.length === 0) {
                    diaryList.innerHTML = '<p style="color: var(--secondary-text); text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</p>';
                } else {
                    diaryEntries.forEach(entry => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'diary-entry';
                        entryElement.innerHTML = `
                            <div class="diary-date">${entry.date} ${entry.time}</div>
                            <div class="diary-content">${entry.content}</div>
                        `;
                        diaryList.appendChild(entryElement);
                    });
                }
                
                diaryEntriesDiv.style.display = 'block';
            });
            
            document.getElementById('clearDiary').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥è®°è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                    diaryEntries = [];
                    localStorage.setItem('diaryEntries', JSON.stringify(diaryEntries));
                    document.getElementById('diaryList').innerHTML = '';
                    alert('æ—¥è®°å·²æ¸…ç©ºï¼');
                }
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // äº‹ä»¶ç›‘å¬
            sendButton.addEventListener('click', sendMessage);
            tarotButton.addEventListener('click', drawTarot);
            activeSendButton.addEventListener('click', activeSend);
            screenshotButton.addEventListener('click', takeScreenshot);
            downloadScreenshot.addEventListener('click', downloadScreenshotFunc);
            closeScreenshot.addEventListener('click', closeScreenshotFunc);
            photoButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleImageSelect);
            removeImage.addEventListener('click', clearImage);
            cancelQuote.addEventListener('click', clearQuote);
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // çŠ¶æ€éšæœºå˜åŒ– - ä½¿ç”¨æ‚¨æä¾›çš„ä¸°å¯ŒçŠ¶æ€é€‰é¡¹
            setInterval(() => {
                const randomStatus = getRandomItem(statusOptions);
                document.getElementById('userStatus').textContent = randomStatus;
            }, 10000);
            
            // åˆå§‹åŒ–åŠ è½½
            loadChatHistory();
            loadImageLibrary();
            
            // åˆå§‹æ¬¢è¿æ¶ˆæ¯ï¼ˆåªæœ‰åœ¨æ²¡æœ‰å†å²è®°å½•æ—¶æ‰æ˜¾ç¤ºï¼‰
            if (chatHistory.length === 0) {
                setTimeout(() => {
                    addMessageToChat('ç‚¹å‡»å¡”ç½—ç‰ŒæŒ‰é’®å¯ä»¥æŠ½å–å¡”ç½—ç‰Œï¼Œç‚¹å‡»é­”æ³•æ£’æŒ‰é’®æˆ‘ä¼šä¸»åŠ¨å‘æ¶ˆæ¯ç»™ä½ å“¦ï¼', 'received');
                }, 1500);
            }
        });
    </script>
</body>
</html>